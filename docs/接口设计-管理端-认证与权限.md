# 管理端接口 - 认证与权限管理

## 基础路径
```
/api/support
```

## 1. 认证相关接口

### 1.1 管理员登录
**接口地址**: `POST /api/support/auth/login`

**请求参数**:
```json
{
  "username": "admin",      // 必填，用户名
  "password": "123456"      // 必填，密码
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "admin": {
      "id": 1,
      "username": "admin",
      "remark": "系统管理员",
      "role": {
        "id": 1,
        "name": "超级管理员",
        "description": "拥有所有权限"
      },
      "permissions": [
        {
          "id": 1,
          "name": "用户管理",
          "code": "user:manage",
          "resource": "/api/support/users",
          "method": "GET"
        }
        // ... 更多权限
      ]
    }
  }
}
```

**业务逻辑**:
1. 验证用户名和密码格式
2. 查询管理员账号，验证密码（使用bcrypt）
3. 检查账号状态是否启用
4. 生成JWT Token（有效期7天）
5. 更新最后登录时间和IP
6. 返回Token和管理员信息（包含角色和权限列表）

---

### 1.2 获取当前管理员信息
**接口地址**: `GET /api/support/auth/profile`

**请求头**:
```
Authorization: Bearer <token>
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "admin",
    "remark": "系统管理员",
    "role": {
      "id": 1,
      "name": "超级管理员"
    },
    "lastLoginTime": "2026-01-07 15:30:00",
    "lastLoginIp": "192.168.1.100"
  }
}
```

---

### 1.3 修改密码
**接口地址**: `PUT /api/support/auth/password`

**请求头**:
```
Authorization: Bearer <token>
```

**请求参数**:
```json
{
  "oldPassword": "123456",     // 必填，旧密码
  "newPassword": "newpass123"  // 必填，新密码（6-20位，包含字母和数字）
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "密码修改成功",
  "data": null
}
```

**业务逻辑**:
1. 验证旧密码是否正确
2. 验证新密码格式
3. 使用bcrypt加密新密码
4. 更新数据库

---

### 1.4 退出登录
**接口地址**: `POST /api/support/auth/logout`

**请求头**:
```
Authorization: Bearer <token>
```

**响应数据**:
```json
{
  "code": 200,
  "message": "退出成功",
  "data": null
}
```

**说明**: 可选实现，前端删除Token即可

---

## 2. 管理员管理接口

> ✅ **说明**：以下管理员、角色、权限管理接口已全部实现。

### 2.1 管理员列表
**接口地址**: `GET /api/support/administrators`

**请求参数**:
```json
{
  "page": 1,              // 页码
  "pageSize": 10,         // 每页数量
  "username": "张三",     // 可选，用户名模糊查询
  "roleId": 2,            // 可选，角色ID筛选
  "status": 1             // 可选，状态筛选：0-禁用 1-启用
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "username": "admin",
        "remark": "系统管理员",
        "role": {
          "id": 1,
          "name": "超级管理员"
        },
        "status": 1,
        "lastLoginTime": "2026-01-07 15:30:00",
        "createdAt": "2026-01-01 00:00:00"
      }
    ],
    "total": 20,
    "page": 1,
    "pageSize": 10,
    "totalPages": 2
  }
}
```

**权限要求**: `administrator:list`

---

### 2.2 创建管理员
**接口地址**: `POST /api/support/administrators`

**请求参数**:
```json
{
  "username": "zhangsan",         // 必填，用户名，3-20位字母数字下划线
  "password": "123456",           // 必填，密码，6-20位
  "remark": "设备管理员",         // 可选，备注
  "roleId": 2                     // 必填，角色ID
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 2,
    "username": "zhangsan",
    "remark": "设备管理员",
    "roleId": 2,
    "status": 1,
    "createdAt": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证用户名是否已存在
2. 验证角色ID是否存在
3. 使用bcrypt加密密码
4. 插入数据库

**权限要求**: `administrator:create`

---

### 2.3 更新管理员
**接口地址**: `PUT /api/support/administrators/:id`

**请求参数**:
```json
{
  "password": "newpass123",  // 可选，新密码
  "remark": "设备管理员",    // 可选，备注
  "roleId": 3,               // 可选，角色ID
  "status": 1                // 可选，状态：0-禁用 1-启用
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 不允许修改admin账号的角色（超级管理员）
2. 如果修改密码，需要使用bcrypt加密
3. 验证角色ID是否存在

**权限要求**: `administrator:update`

---

### 2.4 删除管理员
**接口地址**: `DELETE /api/support/administrators/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 不允许删除admin账号
2. 不允许删除自己的账号
3. 物理删除（真实删除记录）

**权限要求**: `administrator:delete`

---

### 2.5 管理员详情
**接口地址**: `GET /api/support/administrators/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 2,
    "username": "zhangsan",
    "remark": "设备管理员",
    "role": {
      "id": 2,
      "name": "设备管理员",
      "description": "负责设备租赁管理",
      "permissions": [
        {
          "id": 10,
          "name": "设备列表",
          "code": "equipment:list",
          "resource": "/api/support/equipment",
          "method": "GET"
        }
      ]
    },
    "status": 1,
    "lastLoginTime": "2026-01-07 15:30:00",
    "createdAt": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `administrator:detail`

---

## 3. 角色管理接口

### 3.1 角色列表
**接口地址**: `GET /api/support/roles`

**请求参数**:
```json
{
  "page": 1,           // 页码
  "pageSize": 10,      // 每页数量
  "name": "管理员"     // 可选，角色名称模糊查询
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "超级管理员",
        "description": "拥有所有权限",
        "createdAt": "2026-01-01 00:00:00"
      }
    ],
    "total": 5,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
```

**权限要求**: `role:list`

---

### 3.2 创建角色
**接口地址**: `POST /api/support/roles`

**请求参数**:
```json
{
  "name": "笼位管理员",                    // 必填，角色名称
  "description": "负责笼位租赁管理",       // 可选，角色描述
  "permissionIds": [10, 11, 12]          // 必填，权限ID数组
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 6,
    "name": "笼位管理员",
    "description": "负责笼位租赁管理",
    "createdAt": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证角色名称是否已存在
2. 使用事务：先创建角色，再插入角色权限关联

**权限要求**: `role:create`

---

### 3.3 更新角色
**接口地址**: `PUT /api/support/roles/:id`

**请求参数**:
```json
{
  "name": "笼位管理员",               // 可选，角色名称
  "description": "负责笼位管理",      // 可选，角色描述
  "permissionIds": [10, 11, 12, 13]  // 可选，权限ID数组
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 不允许修改超级管理员角色（id=1）
2. 使用事务：更新角色信息，删除旧的权限关联，插入新的权限关联

**权限要求**: `role:update`

---

### 3.4 删除角色
**接口地址**: `DELETE /api/support/roles/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 不允许删除超级管理员角色（id=1）
2. 检查是否有管理员正在使用此角色，有则不允许删除
3. 使用事务：删除角色，删除角色权限关联

**权限要求**: `role:delete`

---

### 3.5 角色详情
**接口地址**: `GET /api/support/roles/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 2,
    "name": "设备管理员",
    "description": "负责设备租赁管理",
    "permissions": [
      {
        "id": 10,
        "name": "设备列表",
        "code": "equipment:list",
        "resource": "/api/support/equipment",
        "method": "GET"
      }
    ],
    "createdAt": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `role:detail`

---

## 4. 权限管理接口

### 4.1 权限树形列表
**接口地址**: `GET /api/support/permissions`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "用户管理",
      "code": "user",
      "resource": "",
      "method": "",
      "parentId": 0,
      "sortOrder": 1,
      "children": [
        {
          "id": 2,
          "name": "用户列表",
          "code": "user:list",
          "resource": "/api/support/users",
          "method": "GET",
          "parentId": 1,
          "sortOrder": 1,
          "children": []
        },
        {
          "id": 3,
          "name": "创建用户",
          "code": "user:create",
          "resource": "/api/support/users",
          "method": "POST",
          "parentId": 1,
          "sortOrder": 2,
          "children": []
        }
      ]
    }
  ]
}
```

**说明**: 返回树形结构的权限列表，用于角色分配权限时的勾选

**权限要求**: `permission:list`

---

### 4.2 创建权限
**接口地址**: `POST /api/support/permissions`

**请求参数**:
```json
{
  "name": "设备列表",                          // 必填，权限名称
  "code": "equipment:list",                   // 必填，权限代码（唯一）
  "resource": "/api/support/equipment",       // 必填，资源路径
  "method": "GET",                            // 必填，请求方法
  "parentId": 10,                             // 可选，父级权限ID，0表示顶级
  "sortOrder": 1                              // 可选，排序
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 50,
    "name": "设备列表",
    "code": "equipment:list",
    "resource": "/api/support/equipment",
    "method": "GET",
    "parentId": 10,
    "sortOrder": 1,
    "createdAt": "2026-01-07 16:00:00"
  }
}
```

**权限要求**: `permission:create`

---

### 4.3 更新权限
**接口地址**: `PUT /api/support/permissions/:id`

**请求参数**:
```json
{
  "name": "设备列表",            // 可选，权限名称
  "code": "equipment:list",     // 可选，权限代码
  "resource": "/api/support/equipment",  // 可选，资源路径
  "method": "GET",              // 可选，请求方法
  "parentId": 10,               // 可选，父级权限ID
  "sortOrder": 2                // 可选，排序
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**权限要求**: `permission:update`

---

### 4.4 删除权限
**接口地址**: `DELETE /api/support/permissions/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有子权限，有则不允许删除
2. 检查是否有角色正在使用此权限，有则不允许删除
3. 删除权限及其角色关联

**权限要求**: `permission:delete`

---

## 5. 权限验证中间件

### 5.1 JWT验证中间件
```javascript
/**
 * 验证JWT Token的中间件
 * 从请求头中提取Token并验证，将管理员信息挂载到req.admin
 */
function authenticateToken(req, res, next) {
  // 实现逻辑
}
```

### 5.2 权限验证中间件
```javascript
/**
 * 验证当前用户是否有访问该资源的权限
 * 根据当前请求的路由和方法，查询用户是否有对应权限
 */
function checkPermission(req, res, next) {
  // 实现逻辑
}
```

### 5.3 使用示例
```javascript
// 需要登录但不验证权限
router.get('/profile', authenticateToken, getProfile);

// 需要登录并验证权限
router.get('/users', authenticateToken, checkPermission, getUserList);
```

---

## 6. 获取管理员选项列表（用于下拉选择）

### 6.1 获取所有启用的管理员
**接口地址**: `GET /api/support/administrators/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "username": "admin",
      "remark": "系统管理员"
    },
    {
      "id": 2,
      "username": "zhangsan",
      "remark": "设备管理员"
    }
  ]
}
```

**说明**: 用于查看管理员列表的下拉选择

**权限要求**: 无（已登录即可）

