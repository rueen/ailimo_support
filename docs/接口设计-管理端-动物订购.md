# 管理端接口 - 动物订购管理

## 基础路径
```
/api/support
```

## 1. 动物订购订单管理接口

### 1.1 动物订购订单列表
**接口地址**: `GET /api/support/animal-orders`

**请求参数**:
```json
{
  "page": 1,                  // 页码
  "page_size": 10,             // 每页数量
  "brand_id": 1,               // 可选，品牌ID筛选
  "variety_id": 1,             // 可选，种类/品系ID筛选
  "specification_id": 1,       // 可选，规格ID筛选
  "gender": 0,                // 可选，性别筛选：0-雌性 1-雄性 2-不限
  "supervisor_name": "李教授", // 可选，导师姓名模糊查询
  "orderer_name": "张三",      // 可选，订购人姓名模糊查询
  "contact_phone": "138",      // 可选，联系电话模糊查询
  "environment_id": 1,         // 可选，环境ID筛选
  "requirement_id": 1,         // 可选，要求ID筛选
  "status": 0,                // 可选，状态筛选：0-待处理 1-进行中 2-已拒绝 3-已完成 4-已取消
  "start_date": "2026-01-01",  // 可选，到货日期范围开始
  "end_date": "2026-01-31"     // 可选，到货日期范围结束
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "brand": {
          "id": 1,
          "name": "上海南方模式生物"
        },
        "variety": {
          "id": 1,
          "name": "C57BL/6"
        },
        "specification": {
          "id": 1,
          "name": "6-8周龄"
        },
        "gender": 0,
        "gender_text": "雌性",
        "supervisor_name": "李教授",
        "orderer_name": "张三",
        "contact_phone": "13800138000",
        "delivery_date": "2026-01-15",
        "province_id": 330000,
        "city_id": 33010000,
        "district_id": 330102,
        "province": {
          "id": 330000,
          "name": "浙江省",
          "code": "330000"
        },
        "city": {
          "id": 33010000,
          "name": "杭州市",
          "code": "330100"
        },
        "district": {
          "id": 330102,
          "name": "西湖区",
          "code": "330102"
        },
        "address": "文三路XXX号",
        "environment": {
          "id": 1,
          "name": "屏障环境"
        },
        "requirement": {
          "id": 1,
          "name": "SPF级"
        },
        "user": {
          "id": 10,
          "name": "张三",
          "phone": "13800138000"
        },
        "status": 0,
        "remark": "需要雌性小鼠",
        "handler": null,
        "reject_reason": null,
        "audit_time": null,
        "audit_by": null,
        "completed_time": null,
        "created_at": "2026-01-07 10:00:00"
      }
    ],
    "total": 50,
    "page": 1,
    "page_size": 10,
    "total_pages": 5
  }
}
```

**权限要求**: `animal_order:list`

---

### 1.2 动物订购订单详情
**接口地址**: `GET /api/support/animal-orders/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "brand": {
      "id": 1,
      "name": "上海南方模式生物"
    },
    "variety": {
      "id": 1,
      "name": "C57BL/6"
    },
    "specification": {
      "id": 1,
      "name": "6-8周龄"
    },
    "gender": 0,
    "gender_text": "雌性",
    "supervisor_name": "李教授",
    "orderer_name": "张三",
    "contact_phone": "13800138000",
    "delivery_date": "2026-01-15",
    "province_id": 330000,
    "city_id": 33010000,
    "district_id": 330102,
    "province": {
      "id": 330000,
      "name": "浙江省",
      "code": "330000"
    },
    "city": {
      "id": 33010000,
      "name": "杭州市",
      "code": "330100"
    },
    "district": {
      "id": 330102,
      "name": "西湖区",
      "code": "330102"
    },
    "address": "文三路XXX号",
    "environment": {
      "id": 1,
      "name": "屏障环境"
    },
    "requirement": {
      "id": 1,
      "name": "SPF级"
    },
    "user": {
      "id": 10,
      "name": "张三",
      "phone": "13800138000",
      "organization": {
        "id": 1,
        "name": "浙江大学"
      }
    },
    "status": 1,
    "remark": "需要雌性小鼠",
    "handler": {
      "id": 2,
      "username": "zhangsan",
      "remark": "订购管理员"
    },
    "reject_reason": null,
    "audit_time": "2026-01-07 15:00:00",
    "audit_by": {
      "id": 1,
      "username": "admin"
    },
    "completed_time": null,
    "created_at": "2026-01-07 10:00:00",
    "updated_at": "2026-01-07 15:00:00"
  }
}
```

**权限要求**: `animal_order:detail`

---

### 1.3 新增动物订购订单
**接口地址**: `POST /api/support/animal-orders`

**请求参数**:
```json
{
  "brand_id": 1,                      // 必填，品牌ID
  "variety_id": 1,                    // 必填，种类/品系ID
  "specification_id": 1,              // 必填，规格ID
  "gender": 0,                       // 必填，性别：0-雌性 1-雄性 2-不限
  "supervisor_name": "李教授",        // 必填，导师姓名
  "orderer_name": "张三",             // 必填，订购人姓名
  "contact_phone": "13800138000",     // 必填，联系电话（11位）
  "delivery_date": "2026-01-15",      // 必填，到货日期
  "province_id": 330000,              // 必填，省份ID
  "city_id": 33010000,                // 必填，城市ID
  "district_id": 330102,              // 必填，区县ID
  "address": "文三路XXX号",          // 必填，详细地址
  "environment_id": 1,                // 必填，环境ID
  "requirement_id": 1,                // 必填，要求ID
  "user_id": 10,                      // 必填，用户ID
  "remark": "需要雌性小鼠"           // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 20,
    "brand_id": 1,
    "variety_id": 1,
    "specification_id": 1,
    "gender": 0,
    "supervisor_name": "李教授",
    "orderer_name": "张三",
    "contact_phone": "13800138000",
    "delivery_date": "2026-01-15",
    "user_id": 10,
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证品牌、种类/品系、规格、环境、要求、用户是否存在
2. 验证种类/品系是否属于指定品牌
3. 验证用户是否审核通过
4. 验证手机号格式
5. 验证到货日期不能是过去的日期
6. 创建订单

**权限要求**: `animal_order:create`

---

### 1.4 编辑动物订购订单
**接口地址**: `PUT /api/support/animal-orders/:id`

**请求参数**:
```json
{
  "brand_id": 1,                      // 可选，品牌ID
  "variety_id": 1,                    // 可选，种类/品系ID
  "specification_id": 1,              // 可选，规格ID
  "gender": 1,                       // 可选，性别
  "supervisor_name": "王教授",        // 可选，导师姓名
  "orderer_name": "李四",             // 可选，订购人姓名
  "contact_phone": "13900139000",     // 可选，联系电话
  "delivery_date": "2026-01-20",      // 可选，到货日期
  "province_id": 330000,              // 可选，省份ID
  "city_id": 33010000,                // 可选，城市ID
  "district_id": 330102,              // 可选，区县ID
  "address": "文三路XXX号",          // 可选，详细地址
  "environment_id": 2,                // 可选，环境ID
  "requirement_id": 2,                // 可选，要求ID
  "user_id": 10,                      // 可选，用户ID
  "remark": "备注信息"               // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 只允许编辑状态为"待处理"的订单
2. 验证逻辑同创建订单

**权限要求**: `animal_order:update`

---

### 1.5 审核动物订购订单
**接口地址**: `PUT /api/support/animal-orders/:id/audit`

**请求参数**:
```json
{
  "status": 1,                    // 必填，审核状态：1-通过 2-拒绝
  "handler_id": 2,                 // 通过时必填，负责人ID
  "reject_reason": "拒绝原因"      // 拒绝时必填，拒绝原因
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "审核通过",  // 或 "审核拒绝"
  "data": null
}
```

**业务逻辑**:

**审核通过（status=1）**：
1. 检查订单状态是否为"待处理"
2. 验证handlerId是否提供且负责人是否存在（handlers表）
3. 更新订单状态为"进行中"（1）
4. 记录负责人ID（handler_id）、审核时间（audit_time）和审核人（audit_by，当前登录的管理员）

**审核拒绝（status=2）**：
1. 检查订单状态是否为"待处理"
2. 验证rejectReason是否提供
3. 更新订单状态为"已拒绝"（2）
4. 记录拒绝原因、审核时间和审核人

**权限要求**: `animal_order:audit`

**说明**: 统一审核接口，通过status参数区分通过/拒绝，减少接口数量，统一审核逻辑处理。

---

### 1.7 完成动物订购订单
**接口地址**: `PUT /api/support/animal-orders/:id/complete`

**响应数据**:
```json
{
  "code": 200,
  "message": "订单已完成",
  "data": null
}
```

**业务逻辑**:
1. 检查订单状态是否为"进行中"
2. 更新订单状态为"已完成"（3）
3. 记录完成时间

**权限要求**: `animal_order:complete`

---

### 1.8 取消动物订购订单
**接口地址**: `PUT /api/support/animal-orders/:id/cancel`

**响应数据**:
```json
{
  "code": 200,
  "message": "订单已取消",
  "data": null
}
```

**业务逻辑**:
1. 只允许取消状态为"进行中"的订单
2. 更新订单状态为"已取消"（4）

**权限要求**: `animal_order:cancel`

---

## 2. 动物品牌管理接口

### 2.1 品牌列表
**接口地址**: `GET /api/support/animal-brands`

**请求参数**:
```json
{
  "page": 1,          // 页码
  "page_size": 10,     // 每页数量
  "name": "南方"      // 可选，品牌名称模糊查询
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "上海南方模式生物",
        "created_at": "2026-01-01 00:00:00"
      }
    ],
    "total": 5,
    "page": 1,
    "page_size": 10,
    "total_pages": 1
  }
}
```

**权限要求**: `animal_brand:list`

---

### 2.2 创建品牌
**接口地址**: `POST /api/support/animal-brands`

**请求参数**:
```json
{
  "name": "上海南方模式生物"  // 必填，品牌名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "name": "上海南方模式生物",
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证品牌名称唯一性

**权限要求**: `animal_brand:create`

---

### 2.3 更新品牌
**接口地址**: `PUT /api/support/animal-brands/:id`

**请求参数**:
```json
{
  "name": "上海南方模式生物科技"  // 必填，品牌名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 验证新品牌名称唯一性

**权限要求**: `animal_brand:update`

---

### 2.4 删除品牌
**接口地址**: `DELETE /api/support/animal-brands/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有种类/品系关联此品牌，有则不允许删除
2. 检查是否有订单使用此品牌，有则不允许删除
3. 物理删除

**权限要求**: `animal_brand:delete`

---

### 2.5 品牌详情
**接口地址**: `GET /api/support/animal-brands/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "上海南方模式生物",
    "created_at": "2026-01-01 00:00:00",
    "updated_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `animal_brand:detail`

---

### 2.6 获取品牌选项列表
**接口地址**: `GET /api/support/animal-brands/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "上海南方模式生物"
    },
    {
      "id": 2,
      "name": "北京维通利华"
    }
  ]
}
```

**说明**: 返回所有品牌，用于下拉选择

**权限要求**: 无（已登录即可）

---

## 3. 动物种类/品系管理接口

### 3.1 种类/品系列表
**接口地址**: `GET /api/support/animal-varieties`

**请求参数**:
```json
{
  "page": 1,          // 页码
  "page_size": 10,     // 每页数量
  "name": "C57",      // 可选，种类/品系名称模糊查询
  "brand_id": 1        // 可选，所属品牌ID筛选
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "C57BL/6",
        "brand": {
          "id": 1,
          "name": "上海南方模式生物"
        },
        "created_at": "2026-01-01 00:00:00"
      }
    ],
    "total": 20,
    "page": 1,
    "page_size": 10,
    "total_pages": 2
  }
}
```

**权限要求**: `animal_variety:list`

---

### 3.2 创建种类/品系
**接口地址**: `POST /api/support/animal-varieties`

**请求参数**:
```json
{
  "name": "C57BL/6",    // 必填，种类/品系名称
  "brand_id": 1          // 必填，所属品牌ID
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 10,
    "name": "C57BL/6",
    "brand_id": 1,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证品牌是否存在
2. 验证种类/品系名称在同一品牌下的唯一性

**权限要求**: `animal_variety:create`

---

### 3.3 更新种类/品系
**接口地址**: `PUT /api/support/animal-varieties/:id`

**请求参数**:
```json
{
  "name": "C57BL/6J",   // 可选，种类/品系名称
  "brand_id": 2          // 可选，所属品牌ID
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 如果修改品牌，验证新品牌是否存在
2. 验证种类/品系名称在新品牌下的唯一性

**权限要求**: `animal_variety:update`

---

### 3.4 删除种类/品系
**接口地址**: `DELETE /api/support/animal-varieties/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有订单使用此种类/品系，有则不允许删除
2. 物理删除

**权限要求**: `animal_variety:delete`

---

### 3.5 种类/品系详情
**接口地址**: `GET /api/support/animal-varieties/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "C57BL/6",
    "brand": {
      "id": 1,
      "name": "上海南方模式生物"
    },
    "created_at": "2026-01-01 00:00:00",
    "updated_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `animal_variety:detail`

---

### 3.6 根据品牌获取种类/品系选项列表
**接口地址**: `GET /api/support/animal-varieties/options`

**请求参数**:
```json
{
  "brand_id": 1  // 必填，品牌ID
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "C57BL/6"
    },
    {
      "id": 2,
      "name": "BALB/c"
    }
  ]
}
```

**说明**: 返回指定品牌下的所有种类/品系，用于下拉选择

**权限要求**: 无（已登录即可）

---

## 4. 动物规格管理接口

### 4.1 规格列表
**接口地址**: `GET /api/support/animal-specifications`

**请求参数**:
```json
{
  "page": 1,          // 页码
  "page_size": 10,     // 每页数量
  "name": "周龄"      // 可选，规格名称模糊查询
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "6-8周龄",
        "created_at": "2026-01-01 00:00:00"
      }
    ],
    "total": 5,
    "page": 1,
    "page_size": 10,
    "total_pages": 1
  }
}
```

**权限要求**: `animal_specification:list`

---

### 4.2 创建规格
**接口地址**: `POST /api/support/animal-specifications`

**请求参数**:
```json
{
  "name": "6-8周龄"  // 必填，规格名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "name": "6-8周龄",
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证规格名称唯一性

**权限要求**: `animal_specification:create`

---

### 4.3 更新规格
**接口地址**: `PUT /api/support/animal-specifications/:id`

**请求参数**:
```json
{
  "name": "8-10周龄"  // 必填，规格名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 验证新规格名称唯一性

**权限要求**: `animal_specification:update`

---

### 4.4 删除规格
**接口地址**: `DELETE /api/support/animal-specifications/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有订单使用此规格，有则不允许删除
2. 物理删除

**权限要求**: `animal_specification:delete`

---

### 4.5 规格详情
**接口地址**: `GET /api/support/animal-specifications/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "6-8周龄",
    "created_at": "2026-01-01 00:00:00",
    "updated_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `animal_specification:detail`

---

### 4.6 获取规格选项列表
**接口地址**: `GET /api/support/animal-specifications/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "6-8周龄"
    },
    {
      "id": 2,
      "name": "8-10周龄"
    }
  ]
}
```

**说明**: 返回所有规格，用于下拉选择

**权限要求**: 无（已登录即可）

---

## 5. 动物要求管理接口

### 5.1 要求列表
**接口地址**: `GET /api/support/animal-requirements`

**请求参数**:
```json
{
  "page": 1,          // 页码
  "page_size": 10,     // 每页数量
  "name": "SPF"       // 可选，要求名称模糊查询
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "SPF级",
        "created_at": "2026-01-01 00:00:00"
      }
    ],
    "total": 3,
    "page": 1,
    "page_size": 10,
    "total_pages": 1
  }
}
```

**权限要求**: `animal_requirement:list`

---

### 5.2 创建要求
**接口地址**: `POST /api/support/animal-requirements`

**请求参数**:
```json
{
  "name": "SPF级"  // 必填，要求名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "name": "SPF级",
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证要求名称唯一性

**权限要求**: `animal_requirement:create`

---

### 5.3 更新要求
**接口地址**: `PUT /api/support/animal-requirements/:id`

**请求参数**:
```json
{
  "name": "无特定病原体级"  // 必填，要求名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 验证新要求名称唯一性

**权限要求**: `animal_requirement:update`

---

### 5.4 删除要求
**接口地址**: `DELETE /api/support/animal-requirements/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有订单使用此要求，有则不允许删除
2. 物理删除

**权限要求**: `animal_requirement:delete`

---

### 5.5 要求详情
**接口地址**: `GET /api/support/animal-requirements/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "SPF级",
    "created_at": "2026-01-01 00:00:00",
    "updated_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `animal_requirement:detail`

---

### 5.6 获取要求选项列表
**接口地址**: `GET /api/support/animal-requirements/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "SPF级"
    },
    {
      "id": 2,
      "name": "普通级"
    }
  ]
}
```

**说明**: 返回所有要求，用于下拉选择

**权限要求**: 无（已登录即可）

---

## 6. 统计接口

> ⚠️ **说明**：统计接口为**非核心功能**，当前版本暂未实现。这些接口将在后续版本中根据需求实现。

### 6.1 动物订购统计
**接口地址**: `GET /api/support/animal-orders/statistics`

**请求参数**:
```json
{
  "start_date": "2026-01-01",  // 可选，统计开始日期
  "end_date": "2026-01-31"     // 可选，统计结束日期
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,           // 总订单数
    "pending": 10,          // 待处理
    "in_progress": 30,       // 进行中
    "rejected": 5,          // 已拒绝
    "completed": 50,        // 已完成
    "cancelled": 5,         // 已取消
    "brand_ranking": [       // 品牌订购排行
      {
        "brand_id": 1,
        "brand_name": "上海南方模式生物",
        "count": 40
      }
    ],
    "variety_ranking": [     // 品系订购排行
      {
        "variety_id": 1,
        "variety_name": "C57BL/6",
        "count": 30
      }
    ]
  }
}
```

**权限要求**: `animal_order:statistics`

