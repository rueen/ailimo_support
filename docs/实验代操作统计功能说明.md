# 实验代操作统计功能说明

## 功能概述

新增实验代操作统计功能，用于统计每个用户的代操作数据，方便月底与用户结算。

## 功能特点

1. **统计维度**: 日期 × 用户 × 操作类型
2. **统计基准**: 基于订单完成日期，统计动物数量
3. **统计范围**: 只统计已完成状态的订单
4. **时间选择**: 支持月份快捷选择（本月、上月、本季度、上季度）+ 自定义日期范围
5. **数据展示**: 
   - 多级表头（用户 + 操作类型）
   - 周末行黄色高亮
   - 自动计算每日合计和小计
6. **导出功能**: 支持导出Excel（需要安装xlsx库）

## 前端修改清单

### 1. 新增文件

#### 1.1 统计页面
- **路径**: `src/views/experiment/operation-statistics.vue`
- **功能**: 
  - 时间范围选择（快捷选择 + 自定义）
  - 统计表格展示（多级表头、周末高亮）
  - 导出Excel功能
  - 自动计算小计和合计

### 2. 修改文件

#### 2.1 代操作列表页
- **路径**: `src/views/experiment/operation-list.vue`
- **修改内容**:
  - 在操作栏添加"代操作统计"按钮
  - 导入 `BarChartOutlined` 图标
  - 添加 `handleGoToStatistics` 方法，跳转到统计页面

#### 2.2 路由配置
- **路径**: `src/router/index.js`
- **修改内容**:
  - 在"实验代操作"菜单下添加统计页面路由
  - 路径: `/experiment/statistics`
  - 路由名: `ExperimentOperationStatistics`
  - 权限: `experiment_operation:statistics`
  - 设置 `hideInMenu: true`（不在菜单中显示，通过按钮跳转）

### 3. API接口

#### 3.1 统计接口
- **接口**: `getExperimentOperationStatistics`（已存在于 `src/api/experiment.js`）
- **说明**: 此接口已经在代码中声明，但后端需要实现

## 后端配合事项

### 1. 接口实现

需要实现以下接口：

**接口地址**: `GET /api/support/experiment-operations/statistics`

**详细接口设计**: 请查看 `docs/接口设计-管理端-实验代操作统计.md`

**核心要求**:
- 统计已完成订单（status = 3）
- 基于完成日期（completed_time）统计
- 统计动物数量（quantity）
- 按日期、用户、操作类型三个维度分组

**返回数据结构**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "dates": ["2024-12-01", "2024-12-02", ...],
    "users": [
      {
        "id": 1,
        "name": "潘宗友",
        "operations": [
          {"id": 1, "name": "乱笼分笼"},
          {"id": 2, "name": "耳标"}
        ]
      }
    ],
    "data": {
      "2024-12-01_1_1": 6,
      "2024-12-01_1_2": 23
    }
  }
}
```

### 2. 权限配置

需要配置新的权限：
- **权限标识**: `experiment_operation:statistics`
- **权限名称**: 实验代操作统计
- **建议角色**: 管理员、财务人员

## 前端依赖安装

### 安装xlsx库（用于导出Excel）

```bash
npm install xlsx
```

**说明**: 
- 如果不安装此库，导出功能会提示错误，但不影响其他功能使用
- 建议在生产环境部署前安装

## 使用流程

### 1. 查看统计数据

1. 进入"实验代操作" -> "代操作订单"页面
2. 点击"代操作统计"按钮
3. 选择时间范围（默认显示本月）
4. 点击"查询"按钮
5. 查看统计表格

### 2. 导出Excel

1. 在统计页面选择时间范围并查询
2. 点击"导出Excel"按钮
3. 浏览器会自动下载Excel文件
4. 文件名格式: `实验代操作统计_开始日期_结束日期.xlsx`

## 表格说明

### 表格结构

```
| 日期 | 用户1          | 用户1    | 用户2    | 合计 |
|      | 操作类型1      | 操作类型2| 操作类型1|      |
|------|---------------|----------|----------|------|
| 12.1 | 6             | 23       | 15       | 44   |
| 12.2 | 6             | 23       |          | 29   |
| 小计 | 12            | 46       | 15       | 73   |
```

### 表格特性

1. **多级表头**: 
   - 第一行: 用户名（跨多列）
   - 第二行: 操作类型名

2. **周末高亮**: 
   - 周六、周日行显示黄色背景

3. **小计行**: 
   - 显示每列的总和
   - 蓝色背景

4. **合计列**: 
   - 显示每行的总和
   - 橙色背景

5. **空值处理**: 
   - 没有数据的单元格显示为空
   - 不显示0

## 注意事项

### 1. 数据量控制

- 建议统计时间范围不超过3个月
- 如果用户或操作类型过多，表格会很宽，请使用横向滚动查看

### 2. 性能优化

- 后端建议对以下字段添加索引：
  - `experiment_operations(status, completed_time)`
  - `experiment_operations(user_id, operation_content_id, completed_time)`

### 3. 权限配置

- 统计功能需要 `experiment_operation:statistics` 权限
- 建议只授予管理员和财务人员

### 4. 浏览器兼容性

- 建议使用现代浏览器（Chrome、Firefox、Edge）
- 导出功能需要浏览器支持File API

## 测试建议

### 1. 功能测试

1. **入口测试**: 
   - 验证列表页"代操作统计"按钮显示
   - 验证按钮跳转正常

2. **查询测试**:
   - 测试各种快捷选择（本月、上月等）
   - 测试自定义日期范围
   - 测试空数据情况

3. **表格测试**:
   - 验证表头正确显示
   - 验证数据正确展示
   - 验证周末行高亮
   - 验证小计、合计计算正确

4. **导出测试**:
   - 验证Excel导出成功
   - 验证导出数据正确
   - 验证文件名正确

### 2. 性能测试

- 测试大数据量（3个月、多个用户、多种操作类型）的加载速度
- 测试导出大数据量的耗时

### 3. 权限测试

- 验证无权限用户看不到"代操作统计"按钮
- 验证无权限用户无法访问统计页面

## 未来扩展建议

1. **按用户筛选**: 添加用户筛选功能，只统计指定用户
2. **价格统计**: 在操作内容中配置价格，统计金额
3. **图表展示**: 添加柱状图、折线图等可视化展示
4. **后端导出**: 提供后端导出接口，处理大数据量导出
5. **打印功能**: 添加打印预览和打印功能

## 相关文档

1. **接口设计**: `docs/接口设计-管理端-实验代操作统计.md`
2. **原接口设计**: `docs/接口设计-管理端-实验代操作.md`
3. **统计页面**: `src/views/experiment/operation-statistics.vue`
4. **列表页面**: `src/views/experiment/operation-list.vue`

## 联系方式

如有问题，请联系开发团队。
