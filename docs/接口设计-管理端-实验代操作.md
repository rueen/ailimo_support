# 管理端接口 - 实验代操作管理

## 基础路径
```
/api/support
```

## 1. 实验代操作订单管理接口

### 1.1 实验代操作订单列表
**接口地址**: `GET /api/support/experiment-operations`

**请求参数**:
```json
{
  "page": 1,                  // 页码
  "pageSize": 10,             // 每页数量
  "operationContentId": 1,    // 可选，操作内容ID筛选
  "animalTypeId": 1,          // 可选，动物类型ID筛选
  "userName": "张三",         // 可选，预约用户姓名模糊查询
  "userPhone": "138",         // 可选，预约用户手机号模糊查询
  "handlerId": 2,             // 可选，负责人ID筛选
  "status": 0,                // 可选，状态筛选：0-待审核 1-进行中 2-已拒绝 3-已完成 4-已取消
  "reservationDate": "2026-01-10",  // 可选，预约日期筛选
  "startDate": "2026-01-01",        // 可选，预约日期范围开始
  "endDate": "2026-01-31"           // 可选，预约日期范围结束
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "operationContent": {
          "id": 1,
          "name": "灌胃"
        },
        "animalType": {
          "id": 1,
          "name": "小鼠"
        },
        "quantity": 20,
        "user": {
          "id": 10,
          "name": "张三",
          "phone": "13800138000"
        },
        "reservationDate": "2026-01-10",
        "timeSlots": ["09:00-12:00"],
        "status": 0,
        "remark": "需要进行灌胃操作",
        "handler": null,
        "rejectReason": null,
        "auditTime": null,
        "auditBy": null,
        "completedTime": null,
        "createdAt": "2026-01-07 10:00:00"
      }
    ],
    "total": 50,
    "page": 1,
    "pageSize": 10,
    "totalPages": 5
  }
}
```

**权限要求**: `experiment_operation:list`

---

### 1.2 实验代操作订单详情
**接口地址**: `GET /api/support/experiment-operations/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "operationContent": {
      "id": 1,
      "name": "灌胃"
    },
    "animalType": {
      "id": 1,
      "name": "小鼠"
    },
    "quantity": 20,
    "user": {
      "id": 10,
      "name": "张三",
      "phone": "13800138000",
      "organization": {
        "id": 1,
        "name": "浙江大学"
      }
    },
    "reservationDate": "2026-01-10",
    "timeSlots": ["09:00-12:00", "13:00-18:00"],
    "status": 1,
    "remark": "需要进行灌胃操作",
    "handler": {
      "id": 2,
      "username": "zhangsan",
      "remark": "实验操作员"
    },
    "rejectReason": null,
    "auditTime": "2026-01-07 15:00:00",
    "auditBy": {
      "id": 1,
      "username": "admin"
    },
    "completedTime": null,
    "createdAt": "2026-01-07 10:00:00",
    "updatedAt": "2026-01-07 15:00:00"
  }
}
```

**权限要求**: `experiment_operation:detail`

---

### 1.3 新增实验代操作订单
**接口地址**: `POST /api/support/experiment-operations`

**请求参数**:
```json
{
  "operationContentId": 1,                       // 必填，操作内容ID
  "animalTypeId": 1,                             // 必填，动物类型ID
  "quantity": 20,                                // 必填，动物数量
  "userId": 10,                                  // 必填，预约用户ID
  "reservationDate": "2026-01-10",               // 必填，预约日期
  "timeSlots": ["09:00-12:00", "13:00-18:00"],  // 必填，预约时间段数组
  "remark": "需要进行灌胃操作"                   // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 20,
    "operationContentId": 1,
    "animalTypeId": 1,
    "quantity": 20,
    "userId": 10,
    "reservationDate": "2026-01-10",
    "timeSlots": ["09:00-12:00", "13:00-18:00"],
    "status": 0,
    "createdAt": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证操作内容、动物类型、用户是否存在
2. 验证用户是否审核通过
3. 验证预约日期不能是过去的日期
4. 验证时间段必须从预设的时间段模板中选择
5. 验证时间段数组不能为空
6. 创建订单

**权限要求**: `experiment_operation:create`

---

### 1.4 编辑实验代操作订单
**接口地址**: `PUT /api/support/experiment-operations/:id`

**请求参数**:
```json
{
  "operationContentId": 1,                       // 可选，操作内容ID
  "animalTypeId": 1,                             // 可选，动物类型ID
  "quantity": 25,                                // 可选，动物数量
  "userId": 10,                                  // 可选，预约用户ID
  "reservationDate": "2026-01-10",               // 可选，预约日期
  "timeSlots": ["09:00-12:00"],                 // 可选，预约时间段数组
  "remark": "备注信息"                           // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 只允许编辑状态为"待审核"的订单
2. 验证逻辑同创建订单

**权限要求**: `experiment_operation:update`

---

### 1.5 审核实验代操作订单
**接口地址**: `PUT /api/support/experiment-operations/:id/audit`

**请求参数**:
```json
{
  "status": 1,                    // 必填，审核状态：1-通过 2-拒绝
  "handlerId": 2,                 // 通过时必填，负责人ID
  "rejectReason": "拒绝原因"      // 拒绝时必填，拒绝原因
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "审核通过",  // 或 "审核拒绝"
  "data": null
}
```

**业务逻辑**:

**审核通过（status=1）**：
1. 检查订单状态是否为"待审核"
2. 验证handlerId是否提供且负责人是否存在（handlers表）
3. 更新订单状态为"进行中"（1）
4. 记录负责人ID（handler_id）、审核时间（audit_time）和审核人（audit_by，当前登录的管理员）

**审核拒绝（status=2）**：
1. 检查订单状态是否为"待审核"
2. 验证rejectReason是否提供
3. 更新订单状态为"已拒绝"（2）
4. 记录拒绝原因、审核时间和审核人

**权限要求**: `experiment_operation:audit`

**说明**: 统一审核接口，通过status参数区分通过/拒绝，减少接口数量，统一审核逻辑处理。

---

### 1.7 完成实验代操作订单
**接口地址**: `PUT /api/support/experiment-operations/:id/complete`

**响应数据**:
```json
{
  "code": 200,
  "message": "订单已完成",
  "data": null
}
```

**业务逻辑**:
1. 检查订单状态是否为"进行中"
2. 更新订单状态为"已完成"（3）
3. 记录完成时间

**权限要求**: `experiment_operation:complete`

---

### 1.8 取消实验代操作订单
**接口地址**: `PUT /api/support/experiment-operations/:id/cancel`

**响应数据**:
```json
{
  "code": 200,
  "message": "订单已取消",
  "data": null
}
```

**业务逻辑**:
1. 只允许取消状态为"进行中"的订单
2. 更新订单状态为"已取消"（4）

**权限要求**: `experiment_operation:cancel`

---

## 2. 操作内容管理接口

### 2.1 操作内容列表
**接口地址**: `GET /api/support/operation-contents`

**请求参数**:
```json
{
  "page": 1,          // 页码
  "pageSize": 10,     // 每页数量
  "name": "灌胃"      // 可选，操作内容名称模糊查询
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "灌胃",
        "createdAt": "2026-01-01 00:00:00"
      },
      {
        "id": 2,
        "name": "腹腔注射",
        "createdAt": "2026-01-01 00:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
```

**权限要求**: `operation_content:list`

---

### 2.2 创建操作内容
**接口地址**: `POST /api/support/operation-contents`

**请求参数**:
```json
{
  "name": "灌胃"  // 必填，操作内容名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "name": "灌胃",
    "createdAt": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证操作内容名称唯一性

**权限要求**: `operation_content:create`

---

### 2.3 更新操作内容
**接口地址**: `PUT /api/support/operation-contents/:id`

**请求参数**:
```json
{
  "name": "小鼠灌胃"  // 必填，操作内容名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 验证新操作内容名称唯一性

**权限要求**: `operation_content:update`

---

### 2.4 删除操作内容
**接口地址**: `DELETE /api/support/operation-contents/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有订单使用此操作内容，有则不允许删除
2. 物理删除

**权限要求**: `operation_content:delete`

---

### 2.5 操作内容详情
**接口地址**: `GET /api/support/operation-contents/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "灌胃",
    "createdAt": "2026-01-01 00:00:00",
    "updatedAt": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `operation_content:detail`

---

### 2.6 获取操作内容选项列表
**接口地址**: `GET /api/support/operation-contents/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "灌胃"
    },
    {
      "id": 2,
      "name": "腹腔注射"
    }
  ]
}
```

**说明**: 返回所有操作内容，用于下拉选择

**权限要求**: 无（已登录即可）

---

## 3. 实验代操作时间段管理接口

### 3.1 时间段列表
**接口地址**: `GET /api/support/experiment-time-slots`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "startTime": "09:00:00",
      "endTime": "12:00:00",
      "displayTime": "9:00-12:00",
      "description": "上午时段",
      "status": 1,
      "sortOrder": 1
    },
    {
      "id": 2,
      "startTime": "13:00:00",
      "endTime": "18:00:00",
      "displayTime": "13:00-18:00",
      "description": "下午时段",
      "status": 1,
      "sortOrder": 2
    },
    {
      "id": 3,
      "startTime": "18:00:00",
      "endTime": "24:00:00",
      "displayTime": "18:00-24:00",
      "description": "晚上时段（加班时间需额外付加班费）",
      "status": 1,
      "sortOrder": 3
    }
  ]
}
```

**说明**: 返回所有时间段配置，按sortOrder排序

**权限要求**: `experiment_time_slot:list`

---

### 3.2 创建时间段
**接口地址**: `POST /api/support/experiment-time-slots`

**请求参数**:
```json
{
  "startTime": "09:00:00",    // 必填，开始时间
  "endTime": "12:00:00",      // 必填，结束时间
  "description": "上午时段",   // 可选，描述/备注
  "status": 1,                // 可选，状态：0-禁用 1-启用，默认1
  "sortOrder": 1              // 可选，排序，默认0
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 4,
    "startTime": "09:00:00",
    "endTime": "12:00:00",
    "description": "上午时段",
    "status": 1,
    "sortOrder": 1,
    "createdAt": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证时间格式
2. 验证开始时间必须小于结束时间
3. 检查时间段是否与已有时间段冲突

**权限要求**: `experiment_time_slot:create`

---

### 3.3 更新时间段
**接口地址**: `PUT /api/support/experiment-time-slots/:id`

**请求参数**:
```json
{
  "startTime": "09:00:00",    // 可选，开始时间
  "endTime": "12:00:00",      // 可选，结束时间
  "description": "上午时段",   // 可选，描述/备注
  "status": 1,                // 可选，状态：0-禁用 1-启用
  "sortOrder": 1              // 可选，排序
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 验证时间格式
2. 验证开始时间必须小于结束时间
3. 检查时间段是否与其他时间段冲突

**权限要求**: `experiment_time_slot:update`

---

### 3.4 删除时间段
**接口地址**: `DELETE /api/support/experiment-time-slots/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有订单使用此时间段，有则不允许删除
2. 物理删除

**权限要求**: `experiment_time_slot:delete`

---

### 3.5 时间段详情
**接口地址**: `GET /api/support/experiment-time-slots/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "startTime": "09:00:00",
    "endTime": "12:00:00",
    "description": "上午时段",
    "status": 1,
    "sortOrder": 1,
    "createdAt": "2026-01-01 00:00:00",
    "updatedAt": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `experiment_time_slot:detail`

---

### 3.6 获取时间段选项列表
**接口地址**: `GET /api/support/experiment-time-slots/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "startTime": "09:00:00",
      "endTime": "12:00:00",
      "displayTime": "9:00-12:00",
      "description": "上午时段",
      "status": 1
    },
    {
      "id": 2,
      "startTime": "13:00:00",
      "endTime": "18:00:00",
      "displayTime": "13:00-18:00",
      "description": "下午时段",
      "status": 1
    },
    {
      "id": 3,
      "startTime": "18:00:00",
      "endTime": "24:00:00",
      "displayTime": "18:00-24:00",
      "description": "晚上时段（加班时间需额外付加班费）",
      "status": 1
    }
  ]
}
```

**说明**: 返回所有启用的时间段配置，用于前端多选，按sortOrder排序

**权限要求**: 无（已登录即可）

---

### 3.7 提前预约天数配置

**说明**: 实验代操作提前预约天数配置使用统一的系统配置接口，请参考《接口设计-管理端-内容管理.md》中的"系统配置管理接口"章节。

**获取配置**: 使用 `GET /api/support/advance-days` 统一接口，返回所有模块的提前预约天数配置（包含experiment_advance_days字段）

**更新配置**: 使用 `PUT /api/support/system-configs/experiment_advance_days` 接口更新配置值

---

## 4. 统计接口

> ⚠️ **说明**：统计接口为**非核心功能**，当前版本暂未实现。这些接口将在后续版本中根据需求实现。

### 4.1 实验代操作统计
**接口地址**: `GET /api/support/experiment-operations/statistics`

**请求参数**:
```json
{
  "startDate": "2026-01-01",  // 可选，统计开始日期
  "endDate": "2026-01-31"     // 可选，统计结束日期
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,                // 总订单数
    "pending": 10,               // 待审核
    "inProgress": 30,            // 进行中
    "rejected": 5,               // 已拒绝
    "completed": 50,             // 已完成
    "cancelled": 5,              // 已取消
    "operationRanking": [        // 操作内容排行
      {
        "operationContentId": 1,
        "operationContentName": "灌胃",
        "count": 30
      }
    ],
    "animalTypeRanking": [       // 动物类型排行
      {
        "animalTypeId": 1,
        "animalTypeName": "小鼠",
        "count": 50
      }
    ]
  }
}
```

**权限要求**: `experiment_operation:statistics`

