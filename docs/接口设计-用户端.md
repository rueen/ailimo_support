# 用户端接口设计

## 基础路径
```
/api/h5
```

## 1. 用户认证接口

### 1.1 发送验证码
**接口地址**: `POST /api/h5/auth/send-code`

**请求参数**:
```json
{
  "phone": "13800138000",  // 必填，手机号（11位）
  "type": 1                // 必填，类型：1-登录 2-注册
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "验证码已发送",
  "data": {
    "expire_time": "2026-01-07 16:05:00"  // 验证码过期时间（5分钟后）
  }
}
```

**业务逻辑**:
1. 验证手机号格式
2. 检查同一手机号1分钟内是否已发送过验证码（防止频繁发送）
3. 检查同一手机号当天发送次数是否超过10次
4. 生成6位随机数字验证码
5. **当前版本：直接返回验证码（模拟短信）**
6. 将验证码存入数据库，有效期5分钟
7. 未来版本：调用第三方短信服务发送验证码

**频率限制**: 同一手机号1分钟内只能发送1次，每天最多10次

**说明**: 开发阶段返回验证码方便测试
```json
{
  "code": 200,
  "message": "验证码已发送",
  "data": {
    "code": "123456",  // 开发阶段返回，生产环境删除此字段
    "expire_time": "2026-01-07 16:05:00"
  }
}
```

---

### 1.2 用户注册
**接口地址**: `POST /api/h5/auth/register`

**请求参数**:
```json
{
  "name": "张三",                              // 必填，姓名
  "phone": "13800138000",                     // 必填，手机号（11位）
  "code": "123456",                           // 必填，验证码（6位）
  "organization_id": 1,                        // 可选，组织机构ID（选择"其他"时传null）
  "department_id": 1,                          // 可选，学院ID（选择"其他"时传null）
  "research_group_id": 1,                      // 可选，课题组ID（选择"其他"时传null）
  "user_input_organization_name": "其他大学",  // 可选，用户输入的组织机构名称（选择"其他"时必填）
  "user_input_department_name": "其他学院",    // 可选，用户输入的学院名称（选择"其他"时必填）
  "user_input_research_group_name": "其他课题组", // 可选，用户输入的课题组名称（选择"其他"时必填）
  "province_id": 330000,                       // 可选，省份ID
  "city_id": 33010000,                         // 可选，城市ID
  "district_id": 330102,                       // 可选，区县ID
  "address": "文三路XXX号"                    // 可选，详细地址
}
```

**说明**: 
- 省市区必须同时提供或同时不提供
- 可通过 `GET /api/h5/regions` 接口获取地区列表

**响应数据**:
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "message": "注册成功",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 10,
      "userNo": "U202601160001",
      "name": "张三",
      "phone": "13800138000",
      "organization": {
        "id": 1,
        "name": "浙江大学"
      },
      "department": {
        "id": 1,
        "name": "生命科学学院"
      },
      "research_group": {
        "id": 1,
        "name": "生物医学研究组"
      },
      "status": 1,
      "audit_status": 0,
      "reject_reason": null
    }
  }
}
```

**字段说明**:
- `token`: JWT认证令牌（有效期30天）
- `audit_status`: 审核状态（注册时默认为0-待审核）
- 返回数据结构与登录接口保持一致

**业务逻辑**:
1. 验证手机号格式和唯一性
2. 验证验证码是否正确且未过期
3. 验证参数逻辑：
   - 如果 organization_id 有值，验证组织机构是否存在
   - 如果 organization_id 为null，验证 user_input_organization_name 必须有值
   - 如果 department_id 有值，验证学院是否存在且属于所选组织机构
   - 如果 department_id 为null，验证 user_input_department_name 必须有值
   - 如果 research_group_id 有值，验证课题组是否存在且属于所选学院
   - 如果 research_group_id 为null，验证 user_input_research_group_name 必须有值
4. 创建用户，审核状态设为"待审核"（audit_status=0）
5. 标记验证码为已使用
6. 生成JWT Token并返回
7. **注册成功后自动登录**，前端保存token后根据audit_status=0显示"审核中"页面
8. 用户可以登录查看审核状态，但需等待管理员审核通过后才能使用核心功能

**频率限制**: 同一IP每小时最多注册5次

---

### 1.3 用户登录
**接口地址**: `POST /api/h5/auth/login`

**请求参数**:
```json
{
  "phone": "13800138000",  // 必填，手机号
  "code": "123456"         // 必填，验证码
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 10,
      "userNo": "U202601160001",
      "name": "张三",
      "phone": "13800138000",
      "organization": {
        "id": 1,
        "name": "浙江大学"
      },
      "department": {
        "id": 1,
        "name": "生命科学学院"
      },
      "research_group": {
        "id": 1,
        "name": "生物医学研究组"
      },
      "status": 1,
      "audit_status": 1,
      "reject_reason": null
    }
  }
}
```

**字段说明**:
- `audit_status`: 审核状态（0-待审核，1-审核通过，2-审核未通过）
- `reject_reason`: 审核拒绝原因（仅当 audit_status=2 时有值）

**业务逻辑**:
1. 验证手机号和验证码
2. 检查用户是否存在
3. 检查用户状态是否启用（status=0 的禁用账号不允许登录）
4. 审核中（audit_status=0）、审核通过（audit_status=1）、审核未通过（audit_status=2）的用户都允许登录
5. 生成JWT Token（有效期30天）
6. 标记验证码为已使用
7. 返回Token和用户信息（包含审核状态和拒绝原因）
8. 前端根据 audit_status 显示相应页面：
   - audit_status=0：显示"审核中"页面
   - audit_status=1：正常使用
   - audit_status=2：显示"审核未通过"页面，展示拒绝原因

**错误情况**:
- 用户不存在：提示"该手机号未注册"
- 用户被禁用：提示"账号已被禁用，请联系管理员"
- 审核未通过：提示"账号审核中，请等待审核通过"或"账号审核未通过：{拒绝原因}"

**频率限制**: 同一IP每分钟最多尝试5次

---

### 1.4 获取个人信息
**接口地址**: `GET /api/h5/auth/profile`

**请求头**:
```
Authorization: Bearer <token>
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 10,
    "name": "张三",
    "phone": "13800138000",
    "province_id": 330000,
    "city_id": 33010000,
    "district_id": 330102,
    "province": {
      "id": 330000,
      "name": "浙江省",
      "code": "330000"
    },
    "city": {
      "id": 33010000,
      "name": "杭州市",
      "code": "330100"
    },
    "district": {
      "id": 330102,
      "name": "西湖区",
      "code": "330102"
    },
    "address": "文三路XXX号",
    "organization": {
      "id": 1,
      "name": "浙江大学"
    },
    "department": {
      "id": 1,
      "name": "生命科学学院"
    },
    "research_group": {
      "id": 1,
      "name": "生物医学研究组"
    },
    "status": 1,
    "audit_status": 1,
    "created_at": "2026-01-01 09:00:00",
    "updated_at": "2026-01-05 10:00:00"
  }
}
```

**权限要求**: 需要登录

---

### 1.5 查看审核状态
**接口地址**: `GET /api/h5/auth/audit-status`

**请求头**:
```
Authorization: Bearer <token>
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "user_id": 10,
    "user_no": "U202601160001",
    "name": "张三",
    "phone": "13800138000",
    "audit_status": 1,
    "audit_status_text": "审核通过",
    "reject_reason": null,
    "audit_time": "2026-01-08 10:30:00",
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**审核状态说明**:
- `audit_status = 0`: 待审核
- `audit_status = 1`: 审核通过
- `audit_status = 2`: 审核拒绝（此时 reject_reason 字段包含拒绝原因）

**被拒绝时的响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "user_id": 10,
    "user_no": "U202601160001",
    "name": "张三",
    "phone": "13800138000",
    "audit_status": 2,
    "audit_status_text": "审核拒绝",
    "reject_reason": "提供的组织机构信息不正确，请重新提交",
    "audit_time": "2026-01-08 10:30:00",
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**使用场景**:
- 用户注册后，可以轮询此接口查询审核进度
- 在应用启动时调用此接口，判断是否需要跳转到审核页面
- 审核被拒绝时，可以展示拒绝原因，引导用户联系管理员或重新注册

**权限要求**: 需要登录（但不要求审核通过，这样才能查询到审核状态）

**说明**:
- 此接口专门用于查询审核状态，返回信息更简洁
- `GET /api/h5/auth/profile` 接口返回完整的用户信息（包括审核状态）
- 建议前端在需要轮询审核状态时使用此接口，其他场景使用 profile 接口

---

### 1.6 获取个人信息
**接口地址**: `GET /api/h5/auth/profile`

**请求头**:
```
Authorization: Bearer <token>
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 10,
    "user_no": "U202601160001",
    "name": "张三",
    "phone": "13800138000",
    "province_id": 330000,
    "city_id": 33010000,
    "district_id": 330102,
    "province": {
      "id": 330000,
      "name": "浙江省",
      "code": "330000"
    },
    "city": {
      "id": 33010000,
      "name": "杭州市",
      "code": "330100"
    },
    "district": {
      "id": 330102,
      "name": "西湖区",
      "code": "330102"
    },
    "address": "文三路XXX号",
    "organization": {
      "id": 1,
      "name": "浙江大学"
    },
    "department": {
      "id": 1,
      "name": "生命科学学院"
    },
    "research_group": {
      "id": 1,
      "name": "生物医学研究组"
    },
    "status": 1,
    "audit_status": 1,
    "created_at": "2026-01-01 09:00:00",
    "updated_at": "2026-01-05 10:00:00"
  }
}
```

**权限要求**: 需要登录

---

### 1.7 退出登录
**接口地址**: `POST /api/h5/auth/logout`

**请求头**:
```
Authorization: Bearer <token>
```

**响应数据**:
```json
{
  "code": 200,
  "message": "退出成功",
  "data": null
}
```

**说明**: 前端删除Token即可

---

## 2. 设备预约接口

### 2.1 设备列表
**接口地址**: `GET /api/h5/equipment`

**请求参数**:
```json
{
  "name": "显微镜"    // 可选，设备名称模糊查询
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "高倍显微镜",
      "details": {
        "base_info": "德国进口高倍显微镜",
        "image": ["https://oss.example.com/img1.jpg"],
        "specs": "放大倍数1000倍"
      }
    },
    {
      "id": 2,
      "name": "离心机",
      "details": {
        "base_info": "高速离心机",
        "image": ["https://oss.example.com/img2.jpg"],
        "specs": "最大转速15000rpm"
      }
    }
  ]
}
```

**权限要求**: 无需登录

---

### 2.2 设备详情
**接口地址**: `GET /api/h5/equipment/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "高倍显微镜",
    "details": {
      "base_info": "德国进口高倍显微镜",
      "image": ["https://oss.example.com/img1.jpg"],
      "specs": "放大倍数1000倍",
      "usage": "适用于细胞观察、组织切片等"
    }
  }
}
```

**权限要求**: 无需登录

---

### 2.3 查询设备可用时间段
**接口地址**: `GET /api/h5/equipment/:id/available-slots`

**请求参数**:
```json
{
  "date": "2026-01-10"  // 必填，查询日期
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "start_time": "09:00:00",
      "end_time": "10:00:00",
      "display_time": "09:00-10:00",
      "description": "上午时段1",
      "available": false
    },
    {
      "id": 2,
      "start_time": "10:00:00",
      "end_time": "11:00:00",
      "display_time": "10:00-11:00",
      "description": "上午时段2",
      "available": false
    },
    {
      "id": 3,
      "start_time": "11:00:00",
      "end_time": "12:00:00",
      "display_time": "11:00-12:00",
      "description": "上午时段3",
      "available": true
    },
    {
      "id": 4,
      "start_time": "13:00:00",
      "end_time": "14:00:00",
      "display_time": "13:00-14:00",
      "description": "下午时段1",
      "available": true
    }
  ]
}
```

**字段说明**:
- `id`: 时间段ID
- `startTime`: 开始时间
- `end_time`: 结束时间
- `display_time`: 显示时间（格式：HH:MM-HH:MM）
- `description`: 时间段描述
- `available`: 是否可用（true-可用，false-已被预约）

**业务逻辑**:
1. 查询所有启用的时间段配置（`equipment_time_slots`表，`status=1`）
2. 查询该设备在该日期已预约的时间段（状态为待审核或进行中）
3. 计算可用时间段（时间段配置中排除已预约的）
4. 按`sort_order`排序

**权限要求**: 需要登录

---

### 2.4 获取设备预约时间段列表
**接口地址**: `GET /api/h5/equipment-time-slots`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "start_time": "09:00:00",
      "end_time": "10:00:00",
      "display_time": "9:00-10:00",
      "description": ""
    },
    {
      "id": 2,
      "start_time": "10:00:00",
      "end_time": "11:00:00",
      "display_time": "10:00-11:00",
      "description": ""
    }
  ]
}
```

**说明**: 返回所有启用的时间段配置，按sort_order排序

**权限要求**: 需要登录

---

### 2.5 获取提前预约天数配置（统一接口）
**接口地址**: `GET /api/h5/advance-days`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "equipment_advance_days": 7,      // 设备预约提前预约天数
    "cage_advance_days": 7,            // 笼位预约提前预约天数
    "experiment_advance_days": 7       // 实验代操作提前预约天数
  }
}
```

**说明**: 统一返回所有模块的提前预约天数配置，避免多次请求

**权限要求**: 无需登录

---

### 2.6 提交设备预约订单
**接口地址**: `POST /api/h5/equipment-orders`

**请求头**:
```
Authorization: Bearer <token>
```

**请求参数**:
```json
{
  "equipment_id": 1,                                                              // 必填，设备ID
  "time_slots": ["2026-01-10 09:00-10:00", "2026-01-10 10:00-11:00", "2026-01-11 09:00-10:00"],  // 必填，预约时间段数组（日期+时间段，支持跨天）
  "remark": "需要使用显微镜进行细胞观察"                                         // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "提交成功，请等待审核",
  "data": {
    "id": 20,
    "equipment_id": 1,
    "time_slots": ["2026-01-10 09:00-10:00", "2026-01-10 10:00-11:00", "2026-01-11 09:00-10:00"],
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证当前用户是否已登录且审核已通过
2. 验证设备是否存在且启用
3. 验证时间段格式（必须包含日期）和有效性
4. 验证预约日期不能是过去的日期
5. 验证预约日期不能超过提前预约天数限制
6. 检查设备在选定时间段是否已被预约（使用数据库行锁防止并发冲突）
7. 自动关联当前登录用户
8. 创建订单，状态为"待审核"

**说明**：调整后支持跨天预约，一个订单可以包含多个日期的时间段

**权限要求**: 需要登录且审核通过

---

## 3. 笼位预约接口

### 3.1 根据动物类型获取环境类型选项
**接口地址**: `GET /api/h5/cages/environments-by-animal-type`

**请求参数**:
```json
{
  "animal_type_id": 1  // 必填，动物类型ID
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "屏障环境"
    },
    {
      "id": 2,
      "name": "SPF环境"
    }
  ]
}
```

**业务逻辑**:
1. 根据动物类型ID查询所有包含该动物类型的笼位
2. 返回去重后的环境类型列表
3. 用于前端级联选择：先选动物类型，再根据动物类型筛选可用的环境类型

**权限要求**: 无需登录

---

### 3.2 查询笼位可用时间段
**接口地址**: `GET /api/h5/cages/available-time-slots`

**请求参数**:
```json
{
  "animal_type_id": 1,     // 必填，动物类型ID
  "environment_id": 1,     // 必填，环境ID
  "date": "2026-01-10"     // 必填，查询日期（YYYY-MM-DD格式）
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total_quantity": 100,  // 该动物类型+环境的总笼位数量
    "time_slots": [
      {
        "id": 1,
        "start_time": "09:00:00",
        "end_time": "10:00:00",
        "display_time": "09:00-10:00",
        "description": "",
        "available_quantity": 70  // 该时间段可用数量
      },
      {
        "id": 2,
        "start_time": "10:00:00",
        "end_time": "11:00:00",
        "display_time": "10:00-11:00",
        "description": "",
        "available_quantity": 50  // 该时间段可用数量
      }
    ]
  }
}
```

**业务逻辑**:
1. 验证动物类型和环境ID是否存在
2. 查询匹配的笼位总数量（animal_type_id + environment_id）
3. 如果没有匹配的笼位，返回 total_quantity = 0，time_slots = []
4. 获取所有已启用状态（status=1）的时间段配置
5. 对于每个时间段，计算该日期该时间段的已预约数量：
   - 查询该动物类型+环境在该日期的所有订单（状态为：0-待审核、1-进行中）
   - 筛选时间段有交集的订单
   - 累加这些订单的 quantity
6. 计算每个时间段的可用数量：total_quantity - 已预约数量
7. 按 sort_order 和 start_time 排序返回

**使用场景**:
- 前端在用户选择动物类型、环境类型和日期后，调用此接口展示各时间段的可用数量
- 用户根据可用数量选择时间段和笼位数量
- 提交订单前校验所选数量是否超过可用数量

**权限要求**: 无需登录

---

### 3.3 获取笼位预约时间段列表
**接口地址**: `GET /api/h5/cage-time-slots`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "start_time": "09:00:00",
      "end_time": "10:00:00",
      "display_time": "9:00-10:00",
      "description": ""
    },
    {
      "id": 2,
      "start_time": "10:00:00",
      "end_time": "11:00:00",
      "display_time": "10:00-11:00",
      "description": ""
    }
  ]
}
```

**说明**: 返回所有启用的时间段配置，按sort_order排序

**权限要求**: 需要登录

---

### 3.4 提前预约天数配置

**说明**: 笼位预约提前预约天数配置使用统一的 `GET /api/h5/advance-days` 接口获取（见2.5节），返回数据中包含 `cage_advance_days` 字段。

---

### 3.5 提交笼位预约订单
**接口地址**: `POST /api/h5/cage-orders`

**请求头**:
```
Authorization: Bearer <token>
```

**请求参数**:
```json
{
  "animal_type_id": 1,                             // 必填，动物类型ID
  "environment_id": 1,                            // 必填，环境ID
  "quantity": 10,                                // 必填，数量
  "purpose_id": 1,                                // 必填，用途ID
  "reservation_date": "2026-01-10",               // 必填，预约日期
  "time_slots": ["09:00-10:00", "10:00-11:00"],  // 必填，预约时间段数组
  "remark": "需要繁殖用笼位"                     // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "提交成功，请等待审核",
  "data": {
    "id": 20,
    "animal_type_id": 1,
    "environment_id": 1,
    "quantity": 10,
    "reservation_date": "2026-01-10",
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证动物类型、环境、用途是否存在
2. 验证预约日期和时间段
3. **检查笼位数量是否足够**：
   - 查询该动物类型+环境组合在该日期已审核通过（status=1）或待审核（status=0）的订单
   - 计算该日期各时间段已占用的笼位数量
   - 检查所选时间段是否有足够的可用笼位数量（总数量 - 已占用数量 >= 申请数量）
   - 如果数量不足，返回错误提示"该时间段可用笼位数量不足"
4. 创建订单，状态为"待审核"（注意：此时不占用笼位数量，只有审核通过后才占用）
5. 自动关联当前登录用户

**前端交互流程**:
1. 用户选择动物类型 → 调用 3.1 接口获取可选的环境类型
2. 用户选择环境类型和日期 → 调用 3.2 接口获取各时间段的可用数量
3. 用户选择时间段和笼位数量 → 前端校验数量是否超过可用数量
4. 提交订单 → 后端再次验证可用数量（防止并发问题）

**权限要求**: 需要登录且审核通过

---

## 4. 实验代操作接口

### 4.1 获取实验代操作时间段列表
**接口地址**: `GET /api/h5/experiment-time-slots`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "start_time": "09:00:00",
      "end_time": "12:00:00",
      "display_time": "9:00-12:00",
      "description": "上午时段",
      "status": 1
    },
    {
      "id": 2,
      "start_time": "13:00:00",
      "end_time": "18:00:00",
      "display_time": "13:00-18:00",
      "description": "下午时段",
      "status": 1
    },
    {
      "id": 3,
      "start_time": "18:00:00",
      "end_time": "24:00:00",
      "display_time": "18:00-24:00",
      "description": "晚上时段（加班时间需额外付加班费）",
      "status": 1
    }
  ]
}
```

**说明**: 返回所有启用的时间段配置，用于前端多选，按sort_order排序

**权限要求**: 无需登录

---

### 4.2 提前预约天数配置

**说明**: 实验代操作提前预约天数配置使用统一的 `GET /api/h5/advance-days` 接口获取（见2.5节），返回数据中包含 `experiment_advance_days` 字段。

---

### 4.3 提交实验代操作订单
**接口地址**: `POST /api/h5/experiment-orders`

**请求头**:
```
Authorization: Bearer <token>
```

**请求参数**:
```json
{
  "operation_content_id": 1,                                                               // 必填，操作内容ID
  "animal_type_id": 1,                                                                     // 必填，动物类型ID
  "quantity": 20,                                                                        // 必填，动物数量
  "time_slots": ["2026-01-10 09:00-12:00", "2026-01-10 13:00-18:00", "2026-01-11 09:00-12:00"],  // 必填，预约时间段数组（日期+时间段，支持跨天）
  "remark": "需要进行灌胃操作"                                                           // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "提交成功，请等待审核",
  "data": {
    "id": 20,
    "operation_content_id": 1,
    "animal_type_id": 1,
    "quantity": 20,
    "time_slots": ["2026-01-10 09:00-12:00", "2026-01-10 13:00-18:00", "2026-01-11 09:00-12:00"],
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证操作内容、动物类型是否存在
2. 验证时间段格式（必须包含日期）和有效性
3. 验证预约日期不能是过去的日期
4. 验证预约日期不能超过提前预约天数限制
5. 创建订单，状态为"待审核"
6. 自动关联当前登录用户

**说明**：调整后支持跨天预约，一个订单可以包含多个日期的时间段

**权限要求**: 需要登录且审核通过

---

## 5. 动物订购接口

### 5.1 根据品牌获取种类/品系列表
**接口地址**: `GET /api/h5/animal-varieties`

**请求参数**:
```json
{
  "brand_id": 1  // 必填，品牌ID
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "C57BL/6"
    },
    {
      "id": 2,
      "name": "BALB/c"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 5.2 提交动物订购订单
**接口地址**: `POST /api/h5/animal-orders`

**请求头**:
```
Authorization: Bearer <token>
```

**请求参数**:
```json
{
  "brand_id": 1,                      // 必填，品牌ID
  "variety_id": 1,                    // 必填，种类/品系ID
  "specification_id": 1,              // 必填，规格ID
  "gender": 0,                       // 必填，性别：0-雌性 1-雄性 2-不限
  "supervisor_name": "李教授",        // 必填，导师姓名
  "orderer_name": "张三",             // 必填，订购人姓名
  "contact_phone": "13800138000",     // 必填，联系电话
  "delivery_date": "2026-01-15",      // 必填，到货日期
  "province_id": 330000,              // 必填，省份ID
  "city_id": 33010000,                // 必填，城市ID
  "district_id": 330102,              // 必填，区县ID
  "address": "文三路XXX号",          // 必填，详细地址
  "environment_id": 1,                // 必填，环境ID
  "requirement_id": 1,                // 必填，要求ID
  "remark": "需要雌性小鼠"           // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "提交成功，请等待处理",
  "data": {
    "id": 20,
    "brand_id": 1,
    "variety_id": 1,
    "delivery_date": "2026-01-15",
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证所有关联数据是否存在
2. 验证手机号格式
3. 验证到货日期不能是过去的日期
4. 创建订单，状态为"待处理"
5. 自动关联当前登录用户

**权限要求**: 需要登录且审核通过

---

## 6. 试剂耗材订购接口

### 6.1 提交试剂耗材订购订单
**接口地址**: `POST /api/h5/reagent-orders`

**请求头**:
```
Authorization: Bearer <token>
```

**请求参数**:
```json
{
  "name": "PCR试剂盒",               // 必填，试剂耗材名称
  "brand_id": 1,                      // 必填，品牌ID
  "specification_id": 1,              // 必填，规格ID
  "quantity": 5,                     // 必填，数量
  "orderer_name": "张三",             // 必填，订购人姓名
  "contact_phone": "13800138000",     // 必填，联系电话
  "delivery_date": "2026-01-15",      // 必填，到货日期
  "province_id": 330000,              // 必填，省份ID
  "city_id": 33010000,                // 必填，城市ID
  "district_id": 330102,              // 必填，区县ID
  "address": "文三路XXX号",          // 必填，详细地址
  "remark": "急需试剂盒"             // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "提交成功，请等待处理",
  "data": {
    "id": 20,
    "name": "PCR试剂盒",
    "brand_id": 1,
    "delivery_date": "2026-01-15",
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证品牌、规格是否存在
2. 验证手机号格式
3. 验证到货日期不能是过去的日期
4. 验证数量必须大于0
5. 创建订单，状态为"待处理"
6. 自动关联当前登录用户

**权限要求**: 需要登录且审核通过

---

## 7. 案例管理接口

### 7.1 案例列表
**接口地址**: `GET /api/h5/cases`

**请求参数**:
```json
{
  "page": 1,                  // 页码
  "page_size": 10,             // 每页数量
  "project_name": "肿瘤",      // 可选，项目名称模糊查询
  "project_summary": "研究"    // 可选，项目概述模糊查询
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "project_name": "肿瘤免疫治疗研究",
        "project_summary": "针对多种肿瘤的免疫治疗方法研究...",
        "images": [
          "https://oss.example.com/case1_1.jpg"
        ],
        "created_at": "2026-01-01 00:00:00"
      }
    ],
    "total": 20,
    "page": 1,
    "page_size": 10,
    "total_pages": 2
  }
}
```

**说明**: 只返回启用状态的案例

**权限要求**: 无需登录

---

### 7.2 案例详情
**接口地址**: `GET /api/h5/cases/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "project_name": "肿瘤免疫治疗研究",
    "project_summary": "针对多种肿瘤的免疫治疗方法研究...",
    "project_result": "成功开发出新型免疫治疗方案...",
    "images": [
      "https://oss.example.com/case1_1.jpg",
      "https://oss.example.com/case1_2.jpg"
    ],
    "created_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: 无需登录

---

## 8. 公司信息接口

### 8.1 获取公司信息
**接口地址**: `GET /api/h5/company-info`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "company_name": "艾力默生物科技有限公司",
    "company_address": "浙江省杭州市西湖区文三路XXX号",
    "contact_phone": "0571-12345678",
    "email": "info@ailimo.com",
    "work_time": "周一至周五 9:00-18:00",
    "company_intro": "艾力默生物科技是一家专注于实验动物服务的公司...",
    "service_concept": "专业、高效、贴心的一站式实验动物服务",
    "banner_image": [],
    "video_url": "https://example.com/logo.mp4",
  }
}
```

**说明**: 
- 公司信息以 JSON 格式存储，字段可动态扩展
- 具体包含哪些字段由管理端配置决定
- 上述字段仅为示例

**权限要求**: 无需登录

---

## 9. 通用接口

### 9.1 获取组织机构列表
**接口地址**: `GET /api/h5/organizations`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "浙江大学"
    },
    {
      "id": 2,
      "name": "复旦大学"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.2 根据组织机构获取学院列表
**接口地址**: `GET /api/h5/departments`

**请求参数**:
```json
{
  "organization_id": 1  // 必填，组织机构ID
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "生命科学学院"
    },
    {
      "id": 2,
      "name": "医学院"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.3 根据学院获取课题组列表
**接口地址**: `GET /api/h5/research-groups`

**请求参数**:
```json
{
  "department_id": 1  // 必填，学院ID
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "生物医学研究组"
    },
    {
      "id": 2,
      "name": "化学研究组"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.4 获取环境类型列表
**接口地址**: `GET /api/h5/environment-types`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "屏障环境"
    },
    {
      "id": 2,
      "name": "非屏障环境"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.5 获取动物类型列表
**接口地址**: `GET /api/h5/animal-types`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "小鼠"
    },
    {
      "id": 2,
      "name": "大鼠"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.6 获取笼位用途列表
**接口地址**: `GET /api/h5/cage-purposes`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "繁殖"
    },
    {
      "id": 2,
      "name": "实验"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.7 获取操作内容列表
**接口地址**: `GET /api/h5/operation-contents`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "灌胃"
    },
    {
      "id": 2,
      "name": "腹腔注射"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.8 获取动物品牌列表
**接口地址**: `GET /api/h5/animal-brands`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "上海南方模式生物"
    },
    {
      "id": 2,
      "name": "北京维通利华"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.9 获取动物规格列表
**接口地址**: `GET /api/h5/animal-specifications`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "6-8周龄"
    },
    {
      "id": 2,
      "name": "8-10周龄"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.10 获取动物要求列表
**接口地址**: `GET /api/h5/animal-requirements`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "SPF级"
    },
    {
      "id": 2,
      "name": "普通级"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.11 获取试剂耗材品牌列表
**接口地址**: `GET /api/h5/reagent-brands`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "Thermo Fisher"
    },
    {
      "id": 2,
      "name": "Sigma-Aldrich"
    }
  ]
}
```

**权限要求**: 无需登录

---

### 9.12 获取试剂耗材规格列表
**接口地址**: `GET /api/h5/reagent-specifications`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "100次/盒"
    },
    {
      "id": 2,
      "name": "500ml/瓶"
    }
  ]
}
```

**权限要求**: 无需登录

---

## 10. 订单统一查询接口

### 10.1 我的所有订单
**接口地址**: `GET /api/h5/my-orders`

**请求头**:
```
Authorization: Bearer <token>
```

**请求参数**:
```json
{
  "page": 1,              // 页码
  "page_size": 10,         // 每页数量
  "type": "equipment",    // 可选，订单类型：equipment-设备预约 cage-笼位预约 experiment-实验代操作 animal-动物订购 reagent-试剂耗材
  "status": 0,            // 可选，状态筛选：0-待审核/待处理 1-进行中 2-已拒绝 3-已完成 4-已取消
  "start_date": "2026-01-01",  // 可选，日期范围开始（预约日期或到货日期）
  "end_date": "2026-01-31"     // 可选，日期范围结束
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "type": "equipment",
        "type_name": "设备预约",
        "title": "高倍显微镜",
        "date": "2026-01-10",
        "status": 0,
        "status_text": "待审核",
        "created_at": "2026-01-07 10:00:00"
      },
      {
        "id": 2,
        "type": "cage",
        "type_name": "笼位预约",
        "title": "小鼠-屏障环境-10个",
        "date": "2026-01-10",
        "status": 1,
        "status_text": "进行中",
        "created_at": "2026-01-06 15:00:00"
      },
      {
        "id": 3,
        "type": "experiment",
        "type_name": "实验代操作",
        "title": "灌胃-小鼠-20只",
        "date": "2026-01-10",
        "status": 0,
        "status_text": "待审核",
        "created_at": "2026-01-05 09:00:00"
      },
      {
        "id": 4,
        "type": "animal",
        "type_name": "动物订购",
        "title": "C57BL/6 小鼠",
        "date": "2026-01-15",
        "status": 1,
        "status_text": "进行中",
        "created_at": "2026-01-06 15:00:00"
      },
      {
        "id": 5,
        "type": "reagent",
        "type_name": "试剂耗材订购",
        "title": "PCR试剂盒",
        "date": "2026-01-15",
        "status": 0,
        "status_text": "待处理",
        "created_at": "2026-01-07 11:00:00"
      }
    ],
    "total": 50,
    "page": 1,
    "page_size": 10,
    "total_pages": 5
  }
}
```

**业务逻辑**:
1. 聚合查询所有类型的订单（设备预约、笼位预约、实验代操作、动物订购、试剂耗材订购）
2. 只返回当前登录用户的订单
3. 根据订单类型返回对应的标题和日期字段：
   - 设备预约：title=设备名称，date=从 time_slots 中提取第一个日期
   - 笼位预约：title=动物类型-环境-数量，date=预约开始日期(start_date)
   - 实验代操作：title=操作内容-动物类型-数量，date=从 time_slots 中提取第一个日期
   - 动物订购：title=种类/品系名称，date=到货日期
   - 试剂耗材订购：title=试剂耗材名称，date=到货日期
4. 支持按订单类型、状态、日期范围筛选
5. 按创建时间倒序排列

**说明**：设备预约和实验代操作订单的 date 字段从 time_slots 数组中提取第一个日期

**权限要求**: 需要登录

---

### 10.2 我的订单详情
**接口地址**: `GET /api/h5/my-orders/:type/:id`

**请求头**:
```
Authorization: Bearer <token>
```

**请求参数**:
- `type`: 订单类型（equipment/cage/experiment/animal/reagent）
- `id`: 订单ID

**响应数据**（根据订单类型返回不同的数据结构）:

**设备预约订单详情**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "type": "equipment",
    "type_name": "设备预约",
    "id": 1,
    "equipment": {
      "id": 1,
      "name": "高倍显微镜",
      "details": {
        "base_info": "德国进口高倍显微镜",
        "image": ["https://oss.example.com/img1.jpg"],
        "specs": "放大倍数1000倍"
      }
    },
    "time_slots": ["2026-01-10 09:00-10:00", "2026-01-10 10:00-11:00", "2026-01-11 09:00-10:00"],
    "status": 1,
    "status_text": "进行中",
    "remark": "需要使用显微镜进行细胞观察",
    "handler": {
      "id": 2,
      "name": "设备管理员"
    },
    "reject_reason": null,
    "audit_time": "2026-01-07 15:00:00",
    "completed_time": null,
    "created_at": "2026-01-07 10:00:00"
  }
}
```

**笼位预约订单详情**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "type": "cage",
    "type_name": "笼位预约",
    "id": 1,
    "animal_type": {
      "id": 1,
      "name": "小鼠"
    },
    "environment": {
      "id": 1,
      "name": "屏障环境"
    },
    "quantity": 10,
    "purpose": {
      "id": 1,
      "name": "繁殖"
    },
    "start_date": "2026-01-10",
    "end_date": "2026-02-10",
    "status": 1,
    "status_text": "进行中",
    "remark": "需要繁殖用笼位",
    "handler": {
      "id": 2,
      "name": "笼位管理员"
    },
    "reject_reason": null,
    "audit_time": "2026-01-07 15:00:00",
    "completed_time": null,
    "created_at": "2026-01-07 10:00:00"
  }
}
```

**实验代操作订单详情**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "type": "experiment",
    "type_name": "实验代操作",
    "id": 1,
    "operation_content": {
      "id": 1,
      "name": "灌胃"
    },
    "animal_type": {
      "id": 1,
      "name": "小鼠"
    },
    "quantity": 20,
    "time_slots": ["2026-01-10 09:00-12:00", "2026-01-10 13:00-18:00", "2026-01-11 09:00-12:00"],
    "status": 1,
    "status_text": "进行中",
    "remark": "需要进行灌胃操作",
    "handler": {
      "id": 2,
      "name": "实验操作员"
    },
    "reject_reason": null,
    "audit_time": "2026-01-07 15:00:00",
    "completed_time": null,
    "created_at": "2026-01-07 10:00:00"
  }
}
```

**动物订购订单详情**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "type": "animal",
    "type_name": "动物订购",
    "id": 1,
    "brand": {
      "id": 1,
      "name": "上海南方模式生物"
    },
    "variety": {
      "id": 1,
      "name": "C57BL/6"
    },
    "specification": {
      "id": 1,
      "name": "6-8周龄"
    },
    "gender": 0,
    "gender_text": "雌性",
    "supervisor_name": "李教授",
    "orderer_name": "张三",
    "contact_phone": "13800138000",
    "delivery_date": "2026-01-15",
    "province_id": 330000,
    "city_id": 33010000,
    "district_id": 330102,
    "province": {
      "id": 330000,
      "name": "浙江省",
      "code": "330000"
    },
    "city": {
      "id": 33010000,
      "name": "杭州市",
      "code": "330100"
    },
    "district": {
      "id": 330102,
      "name": "西湖区",
      "code": "330102"
    },
    "address": "文三路XXX号",
    "environment": {
      "id": 1,
      "name": "屏障环境"
    },
    "requirement": {
      "id": 1,
      "name": "SPF级"
    },
    "status": 1,
    "status_text": "进行中",
    "remark": "需要雌性小鼠",
    "handler": {
      "id": 2,
      "name": "订购管理员"
    },
    "reject_reason": null,
    "audit_time": "2026-01-07 15:00:00",
    "completed_time": null,
    "created_at": "2026-01-07 10:00:00"
  }
}
```

**试剂耗材订购订单详情**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "type": "reagent",
    "type_name": "试剂耗材订购",
    "id": 1,
    "name": "PCR试剂盒",
    "brand": {
      "id": 1,
      "name": "Thermo Fisher"
    },
    "specification": {
      "id": 1,
      "name": "100次/盒"
    },
    "quantity": 5,
    "orderer_name": "张三",
    "contact_phone": "13800138000",
    "delivery_date": "2026-01-15",
    "province_id": 330000,
    "city_id": 33010000,
    "district_id": 330102,
    "province": {
      "id": 330000,
      "name": "浙江省",
      "code": "330000"
    },
    "city": {
      "id": 33010000,
      "name": "杭州市",
      "code": "330100"
    },
    "district": {
      "id": 330102,
      "name": "西湖区",
      "code": "330102"
    },
    "address": "文三路XXX号",
    "status": 1,
    "status_text": "进行中",
    "remark": "急需试剂盒",
    "handler": {
      "id": 2,
      "name": "订购管理员"
    },
    "reject_reason": null,
    "audit_time": "2026-01-07 15:00:00",
    "completed_time": null,
    "created_at": "2026-01-07 10:00:00"
  }
}
```

**业务逻辑**:
1. 根据订单类型（type）和订单ID（id）查询对应的订单详情
2. 只能查看自己的订单详情
3. 返回完整的订单信息，包括关联数据（设备、动物类型、操作内容等）

**权限要求**: 需要登录

