# 管理端接口 - 笼位预约管理

## 基础路径
```
/api/support
```

## 1. 笼位预约订单管理接口

### 1.1 笼位预约订单列表
**接口地址**: `GET /api/support/cage-reservations`

**请求参数**:
```json
{
  "page": 1,              // 页码
  "page_size": 10,         // 每页数量
  "animal_type_id": 1,      // 可选,动物类型ID筛选
  "environment_id": 1,     // 可选,环境ID筛选
  "purpose_id": 1,         // 可选,用途ID筛选
  "user_name": "张三",     // 可选,预约用户姓名模糊查询
  "user_phone": "138",     // 可选,预约用户手机号模糊查询
  "status": 0,            // 可选,状态筛选:0-待审核 1-进行中 2-已拒绝 3-已完成 4-已取消
  "start_date": "2026-01-01",        // 可选,预约开始日期筛选(精确匹配)
  "start_date_from": "2026-01-01",   // 可选,预约开始日期范围开始
  "start_date_to": "2026-01-31"      // 可选,预约开始日期范围结束
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "animal_type": {
          "id": 1,
          "name": "小鼠"
        },
        "environment": {
          "id": 1,
          "name": "屏障环境"
        },
        "quantity": 10,
        "purpose": {
          "id": 1,
          "name": "繁殖"
        },
        "user": {
          "id": 10,
          "name": "张三",
          "phone": "13800138000"
        },
        "start_date": "2026-01-10",
        "end_date": "2026-02-10",
        "status": 0,
        "remark": "需要繁殖用笼位",
        "handler": null,
        "reject_reason": null,
        "audit_time": null,
        "audit_by": null,
        "completed_time": null,
        "created_at": "2026-01-07 10:00:00"
      }
    ],
    "total": 50,
    "page": 1,
    "page_size": 10,
    "total_pages": 5
  }
}
```

**权限要求**: `cage_reservation:list`

---

### 1.2 笼位预约订单详情
**接口地址**: `GET /api/support/cage-reservations/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "cage": {
      "id": 1,
      "animal_type": {
        "id": 1,
        "name": "小鼠"
      },
      "environment": {
        "id": 1,
        "name": "屏障环境"
      },
      "quantity": 100
    },
    "animal_type": {
      "id": 1,
      "name": "小鼠"
    },
    "environment": {
      "id": 1,
      "name": "屏障环境"
    },
    "quantity": 10,
    "purpose": {
      "id": 1,
      "name": "繁殖"
    },
    "user": {
      "id": 10,
      "name": "张三",
      "phone": "13800138000",
      "organization": {
        "id": 1,
        "name": "浙江大学"
      }
    },
    "start_date": "2026-01-10",
    "end_date": "2026-02-10",
    "status": 1,
    "remark": "需要繁殖用笼位",
    "handler": {
      "id": 2,
      "username": "zhangsan",
      "remark": "笼位管理员"
    },
    "reject_reason": null,
    "audit_time": "2026-01-07 15:00:00",
    "audit_by": {
      "id": 1,
      "username": "admin"
    },
    "completed_time": null,
    "created_at": "2026-01-07 10:00:00",
    "updated_at": "2026-01-07 15:00:00"
  }
}
```

**权限要求**: `cage_reservation:detail`

---

### 1.3 新增笼位预约订单
**接口地址**: `POST /api/support/cage-reservations`

**请求参数**:
```json
{
  "animal_type_id": 1,                             // 必填,动物类型ID
  "environment_id": 1,                            // 必填,环境ID
  "quantity": 10,                                // 必填,数量
  "purpose_id": 1,                                // 必填,用途ID
  "user_id": 10,                                  // 必填,预约用户ID
  "start_date": "2026-01-10",                     // 必填,预约开始日期
  "end_date": "2026-02-10",                       // 可选,预约结束日期(NULL表示长期预约)
  "remark": "需要繁殖用笼位"                     // 可选,备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 20,
    "animal_type_id": 1,
    "environment_id": 1,
    "quantity": 10,
    "purpose_id": 1,
    "user_id": 10,
    "start_date": "2026-01-10",
    "end_date": "2026-02-10",
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证动物类型、环境、用途、用户是否存在
2. 验证用户是否审核通过
3. 验证开始日期不能是过去的日期
4. 验证开始日期不能超过提前预约天数限制
5. 验证结束日期不能早于开始日期(如果提供了结束日期)
6. **查询匹配的笼位(动物类型+环境)**
7. **检查笼位在选定日期范围的剩余数量是否足够(使用数据库行锁防止并发)**
8. 自动分配笼位ID
9. 创建订单

**权限要求**: `cage_reservation:create`

---

### 1.4 编辑笼位预约订单
**接口地址**: `PUT /api/support/cage-reservations/:id`

**请求参数**:
```json
{
  "animal_type_id": 1,                             // 可选,动物类型ID
  "environment_id": 1,                            // 可选,环境ID
  "quantity": 15,                                // 可选,数量
  "purpose_id": 2,                                // 可选,用途ID
  "user_id": 10,                                  // 可选,预约用户ID
  "start_date": "2026-01-10",                     // 可选,预约开始日期
  "end_date": "2026-02-10",                       // 可选,预约结束日期
  "remark": "备注信息"                           // 可选,备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 只允许编辑状态为"待审核"的订单
2. 如果修改动物类型、环境、数量、开始日期或结束日期,需要重新验证笼位可用性
3. 验证逻辑同创建订单

**权限要求**: `cage_reservation:update`

---

### 1.5 审核笼位预约订单
**接口地址**: `PUT /api/support/cage-reservations/:id/audit`

**请求参数**:
```json
{
  "status": 1,                    // 必填,审核状态:1-通过 2-拒绝
  "handler_id": 2,                 // 通过时必填,负责人ID
  "reject_reason": "拒绝原因"      // 拒绝时必填,拒绝原因
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "审核通过",  // 或 "审核拒绝"
  "data": null
}
```

**业务逻辑**:

**审核通过(status=1)**:
1. 检查订单状态是否为"待审核"
2. 验证handlerId是否提供且负责人是否存在(handlers表)
3. **再次检查笼位数量是否足够(防止并发审核导致超预约)**:
   - 查询该动物类型+环境组合在该日期范围已审核通过(status=1)或已完成(status=3)的订单(排除当前订单)
   - 计算日期范围内每天已占用的笼位数量
   - 检查日期范围内是否有足够的可用笼位数量(总数量 - 已占用数量 >= 申请数量)
   - 如果数量不足,返回错误提示"该日期范围可用笼位数量不足"
4. **占用笼位数量**:审核通过后,该动物类型+环境组合在该日期范围的可用数量减少(通过订单状态为"进行中"来标识占用)
5. 更新订单状态为"进行中"(1)
6. 记录负责人ID(handler_id)、审核时间(audit_time)和审核人(audit_by,当前登录的管理员)

**审核拒绝(status=2)**:
1. 检查订单状态是否为"待审核"
2. 验证rejectReason是否提供
3. **释放笼位数量**:由于订单是"待审核"状态,尚未占用笼位数量,所以无需释放(订单状态为"进行中"或"已完成"时才占用笼位数量)
4. 更新订单状态为"已拒绝"(2)
5. 记录拒绝原因、审核时间和审核人

**权限要求**: `cage_reservation:audit`

**说明**: 统一审核接口,通过status参数区分通过/拒绝,减少接口数量,统一审核逻辑处理。

---

### 1.7 完成笼位预约订单
**接口地址**: `PUT /api/support/cage-reservations/:id/complete`

**响应数据**:
```json
{
  "code": 200,
  "message": "订单已完成",
  "data": null
}
```

**业务逻辑**:
1. 检查订单状态是否为"进行中"
2. **释放笼位数量**:订单完成后,该动物类型+环境组合在该日期范围的可用数量增加,释放的笼位数量可供其他订单使用
3. 更新订单状态为"已完成"(3)
4. 记录完成时间(completed_time)

**权限要求**: `cage_reservation:complete`

---

### 1.8 取消笼位预约订单
**接口地址**: `PUT /api/support/cage-reservations/:id/cancel`

**响应数据**:
```json
{
  "code": 200,
  "message": "订单已取消",
  "data": null
}
```

**业务逻辑**:
1. 只允许取消状态为"进行中"的订单
2. **释放笼位数量**:取消订单后,该动物类型+环境组合在该日期范围的可用数量增加,释放的笼位数量可供其他订单使用
3. 更新订单状态为"已取消"(4)

**权限要求**: `cage_reservation:cancel`

---

## 2. 笼位管理接口

### 2.1 笼位列表
**接口地址**: `GET /api/support/cages`

**请求参数**:
```json
{
  "page": 1,              // 页码
  "page_size": 10,         // 每页数量
  "animal_type_id": 1,      // 可选,动物类型ID筛选
  "environment_id": 1,     // 可选,环境ID筛选
  "status": 1             // 可选,状态筛选:0-禁用 1-启用
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "animal_type": {
          "id": 1,
          "name": "小鼠"
        },
        "environment": {
          "id": 1,
          "name": "屏障环境"
        },
        "quantity": 100,
        "status": 1,
        "created_at": "2026-01-01 00:00:00"
      }
    ],
    "total": 20,
    "page": 1,
    "page_size": 10,
    "total_pages": 2
  }
}
```

**权限要求**: `cage:list`

---

### 2.2 创建笼位
**接口地址**: `POST /api/support/cages`

**请求参数**:
```json
{
  "animal_type_id": 1,     // 必填,动物类型ID
  "environment_id": 1,    // 必填,环境ID
  "quantity": 100        // 必填,笼位数量
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "animal_type_id": 1,
    "environment_id": 1,
    "quantity": 100,
    "status": 1,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证动物类型和环境是否存在
2. 检查同一动物类型+环境的笼位是否已存在,存在则提示合并或调整数量

**权限要求**: `cage:create`

---

### 2.3 更新笼位
**接口地址**: `PUT /api/support/cages/:id`

**请求参数**:
```json
{
  "animal_type_id": 1,     // 可选,动物类型ID
  "environment_id": 1,    // 可选,环境ID
  "quantity": 150,       // 可选,笼位数量
  "status": 1            // 可选,状态
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 如果减少数量,需要检查是否有足够的空余数量(已预约数量不能超过新数量)

**权限要求**: `cage:update`

---

### 2.4 删除笼位
**接口地址**: `DELETE /api/support/cages/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有未完成的预约订单,有则不允许删除
2. 物理删除

**权限要求**: `cage:delete`

---

### 2.5 笼位详情
**接口地址**: `GET /api/support/cages/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "animal_type": {
      "id": 1,
      "name": "小鼠"
    },
    "environment": {
      "id": 1,
      "name": "屏障环境"
    },
    "quantity": 100,
    "status": 1,
    "created_at": "2026-01-01 00:00:00",
    "updated_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `cage:detail`

---

### 2.6 根据动物类型获取环境类型选项
**接口地址**: `GET /api/support/cages/environments-by-animal-type`

**请求参数**:
```json
{
  "animal_type_id": 1  // 必填,动物类型ID
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "屏障环境"
    },
    {
      "id": 2,
      "name": "SPF环境"
    }
  ]
}
```

**业务逻辑**:
1. 根据动物类型ID查询所有包含该动物类型的笼位
2. 返回去重后的环境类型列表
3. 用于前端级联选择:先选动物类型,再根据动物类型筛选可用的环境类型

**权限要求**: 无(已登录即可)

**说明**: 
- 该接口在 support 端和 h5 端都可使用
- H5端接口地址为 `GET /api/h5/cages/environments-by-animal-type`

---

### 2.7 查询笼位剩余可用数量
**接口地址**: `GET /api/support/cages/available-quantity`

**请求参数**:
```json
{
  "animal_type_id": 1,     // 必填,动物类型ID
  "environment_id": 1,     // 必填,环境ID
  "start_date": "2026-01-10",     // 必填,开始日期(YYYY-MM-DD格式)
  "end_date": "2026-02-10",       // 可选,结束日期(YYYY-MM-DD格式),不传或传null表示查询长期预约的可用性
  "exclude_reservation_id": 123   // 可选,需要排除的订单ID(编辑订单时使用)
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total_quantity": 100,        // 该动物类型+环境的总笼位数量
    "available_quantity": 85      // 日期范围内的最小可用数量
  }
}
```

**业务逻辑**:
1. 验证动物类型和环境ID是否存在
2. 查询匹配的笼位总数量(animal_type_id + environment_id)
3. 如果没有匹配的笼位,返回 total_quantity = 0,available_quantity = 0
4. 遍历日期范围内的每一天(如果end_date为null,只检查start_date当天)
5. 对于每一天,计算已预约数量:
   - 查询该动物类型+环境在该日期的所有订单(状态为:0-待审核、1-进行中)
   - 如果传递了exclude_reservation_id,则排除该订单
   - 累加这些订单的 quantity
6. 计算每天的可用数量:total_quantity - 已预约数量
7. 返回所有天中的**最小可用数量**(确保整个日期范围都有足够笼位)

**使用场景**:

**场景1 - 新增订单:**
- 前端在用户选择动物类型、环境类型和日期范围后,调用此接口展示可用数量
- 用户根据可用数量输入预约数量
- 提交订单前校验所选数量是否超过可用数量

**场景2 - 编辑订单:**
- 编辑订单时,传递 `exclude_reservation_id` 参数（当前编辑的订单ID）
- 系统将排除当前订单的占用数量,正确显示可用数量
- 例如：笼位总数100,订单A占用50,编辑订单A时传 exclude_reservation_id=A的ID,显示可用100

**权限要求**: 无(已登录即可)

**说明**: 
- 该接口在 support 端和 h5 端都可使用
- H5端接口地址为 `GET /api/h5/cages/available-quantity`
- 返回最小可用数量是为了确保用户预约的数量在整个日期范围内都有足够的笼位
- `exclude_reservation_id` 参数仅在编辑订单时使用,新增订单时不传

---

## 3. 笼位用途管理接口

### 3.1 用途列表
**接口地址**: `GET /api/support/cage-purposes`

**请求参数**:
```json
{
  "page": 1,          // 页码
  "page_size": 10,     // 每页数量
  "name": "繁殖"      // 可选,用途名称模糊查询
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "繁殖",
        "created_at": "2026-01-01 00:00:00"
      }
    ],
    "total": 5,
    "page": 1,
    "page_size": 10,
    "total_pages": 1
  }
}
```

**权限要求**: `cage_purpose:list`

---

### 3.2 创建用途
**接口地址**: `POST /api/support/cage-purposes`

**请求参数**:
```json
{
  "name": "繁殖"  // 必填,用途名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "name": "繁殖",
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证用途名称唯一性

**权限要求**: `cage_purpose:create`

---

### 3.3 更新用途
**接口地址**: `PUT /api/support/cage-purposes/:id`

**请求参数**:
```json
{
  "name": "实验繁殖"  // 必填,用途名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 验证新用途名称唯一性

**权限要求**: `cage_purpose:update`

---

### 3.4 删除用途
**接口地址**: `DELETE /api/support/cage-purposes/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有订单使用此用途,有则不允许删除
2. 物理删除

**权限要求**: `cage_purpose:delete`

---

### 3.5 用途详情
**接口地址**: `GET /api/support/cage-purposes/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "繁殖",
    "created_at": "2026-01-01 00:00:00",
    "updated_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `cage_purpose:detail`

---

### 3.6 获取用途选项列表
**接口地址**: `GET /api/support/cage-purposes/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "繁殖"
    },
    {
      "id": 2,
      "name": "实验"
    }
  ]
}
```

**说明**: 返回所有用途,用于下拉选择

**权限要求**: 无(已登录即可)

---

## 4. 提前预约天数配置

**说明**: 笼位预约提前预约天数配置使用统一的系统配置接口,请参考《接口设计-管理端-内容管理.md》中的"系统配置管理接口"章节。

**获取配置**: 使用 `GET /api/support/advance-days` 统一接口,返回所有模块的提前预约天数配置(包含cage_advance_days字段)

**更新配置**: 使用 `PUT /api/support/system-configs/cage_advance_days` 接口更新配置值

---

## 5. 统计接口

> ⚠️ **说明**:统计接口为**非核心功能**,当前版本暂未实现。这些接口将在后续版本中根据需求实现。

### 5.1 笼位预约统计
**接口地址**: `GET /api/support/cage-reservations/statistics`

**请求参数**:
```json
{
  "start_date": "2026-01-01",  // 可选,统计开始日期
  "end_date": "2026-01-31"     // 可选,统计结束日期
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,           // 总订单数
    "pending": 10,          // 待审核
    "in_progress": 30,       // 进行中
    "rejected": 5,          // 已拒绝
    "completed": 50,        // 已完成
    "cancelled": 5,         // 已取消
    "animal_type_ranking": [  // 动物类型使用排行
      {
        "animal_type_id": 1,
        "animal_type_name": "小鼠",
        "count": 50
      }
    ],
    "purpose_ranking": [     // 用途排行
      {
        "purpose_id": 1,
        "purpose_name": "繁殖",
        "count": 30
      }
    ]
  }
}
```

**权限要求**: `cage_reservation:statistics`
