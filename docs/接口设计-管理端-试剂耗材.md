# 管理端接口 - 试剂耗材订购管理

## 基础路径
```
/api/support
```

## 1. 试剂耗材订购订单管理接口

### 1.1 试剂耗材订购订单列表
**接口地址**: `GET /api/support/reagent-orders`

**请求参数**:
```json
{
  "page": 1,                  // 页码
  "pageSize": 10,             // 每页数量
  "name": "试剂盒",           // 可选，试剂耗材名称模糊查询
  "brandId": 1,               // 可选，品牌ID筛选
  "specificationId": 1,       // 可选，规格ID筛选
  "ordererName": "张三",      // 可选，订购人姓名模糊查询
  "contactPhone": "138",      // 可选，联系电话模糊查询
  "status": 0,                // 可选，状态筛选：0-待处理 1-进行中 2-已拒绝 3-已完成 4-已取消
  "startDate": "2026-01-01",  // 可选，到货日期范围开始
  "endDate": "2026-01-31"     // 可选，到货日期范围结束
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "PCR试剂盒",
        "brand": {
          "id": 1,
          "name": "Thermo Fisher"
        },
        "specification": {
          "id": 1,
          "name": "100次/盒"
        },
        "quantity": 5,
        "ordererName": "张三",
        "contactPhone": "13800138000",
        "deliveryDate": "2026-01-15",
        "province": "浙江省",
        "city": "杭州市",
        "district": "西湖区",
        "address": "文三路XXX号",
        "user": {
          "id": 10,
          "name": "张三",
          "phone": "13800138000"
        },
        "status": 0,
        "remark": "急需试剂盒",
        "handler": null,
        "rejectReason": null,
        "auditTime": null,
        "auditBy": null,
        "completedTime": null,
        "created_at": "2026-01-07 10:00:00"
      }
    ],
    "total": 50,
    "page": 1,
    "pageSize": 10,
    "totalPages": 5
  }
}
```

**权限要求**: `reagent_order:list`

---

### 1.2 试剂耗材订购订单详情
**接口地址**: `GET /api/support/reagent-orders/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "PCR试剂盒",
    "brand": {
      "id": 1,
      "name": "Thermo Fisher"
    },
    "specification": {
      "id": 1,
      "name": "100次/盒"
    },
    "quantity": 5,
    "ordererName": "张三",
    "contactPhone": "13800138000",
    "deliveryDate": "2026-01-15",
    "province": "浙江省",
    "city": "杭州市",
    "district": "西湖区",
    "address": "文三路XXX号",
    "user": {
      "id": 10,
      "name": "张三",
      "phone": "13800138000",
      "organization": {
        "id": 1,
        "name": "浙江大学"
      }
    },
    "status": 1,
    "remark": "急需试剂盒",
    "handler": {
      "id": 2,
      "username": "zhangsan",
      "remark": "订购管理员"
    },
    "rejectReason": null,
    "auditTime": "2026-01-07 15:00:00",
    "auditBy": {
      "id": 1,
      "username": "admin"
    },
    "completedTime": null,
    "created_at": "2026-01-07 10:00:00",
    "updated_at": "2026-01-07 15:00:00"
  }
}
```

**权限要求**: `reagent_order:detail`

---

### 1.3 新增试剂耗材订购订单
**接口地址**: `POST /api/support/reagent-orders`

**请求参数**:
```json
{
  "name": "PCR试剂盒",               // 必填，试剂耗材名称
  "brandId": 1,                      // 必填，品牌ID
  "specificationId": 1,              // 必填，规格ID
  "quantity": 5,                     // 必填，数量
  "ordererName": "张三",             // 必填，订购人姓名
  "contactPhone": "13800138000",     // 必填，联系电话（11位）
  "deliveryDate": "2026-01-15",      // 必填，到货日期
  "province": "浙江省",              // 必填，省份
  "city": "杭州市",                  // 必填，城市
  "district": "西湖区",              // 必填，区县
  "address": "文三路XXX号",          // 必填，详细地址
  "userId": 10,                      // 必填，用户ID
  "remark": "急需试剂盒"             // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 20,
    "name": "PCR试剂盒",
    "brandId": 1,
    "specificationId": 1,
    "quantity": 5,
    "ordererName": "张三",
    "contactPhone": "13800138000",
    "deliveryDate": "2026-01-15",
    "userId": 10,
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证品牌、规格、用户是否存在
2. 验证用户是否审核通过
3. 验证手机号格式
4. 验证到货日期不能是过去的日期
5. 验证数量必须大于0
6. 创建订单

**权限要求**: `reagent_order:create`

---

### 1.4 编辑试剂耗材订购订单
**接口地址**: `PUT /api/support/reagent-orders/:id`

**请求参数**:
```json
{
  "name": "PCR试剂盒（升级版）",     // 可选，试剂耗材名称
  "brandId": 2,                      // 可选，品牌ID
  "specificationId": 2,              // 可选，规格ID
  "quantity": 10,                    // 可选，数量
  "ordererName": "李四",             // 可选，订购人姓名
  "contactPhone": "13900139000",     // 可选，联系电话
  "deliveryDate": "2026-01-20",      // 可选，到货日期
  "province": "浙江省",              // 可选，省份
  "city": "杭州市",                  // 可选，城市
  "district": "西湖区",              // 可选，区县
  "address": "文三路XXX号",          // 可选，详细地址
  "userId": 10,                      // 可选，用户ID
  "remark": "备注信息"               // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 只允许编辑状态为"待处理"的订单
2. 验证逻辑同创建订单

**权限要求**: `reagent_order:update`

---

### 1.5 审核试剂耗材订购订单
**接口地址**: `PUT /api/support/reagent-orders/:id/audit`

**请求参数**:
```json
{
  "status": 1,                    // 必填，审核状态：1-通过 2-拒绝
  "handlerId": 2,                 // 通过时必填，负责人ID
  "rejectReason": "拒绝原因"      // 拒绝时必填，拒绝原因
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "审核通过",  // 或 "审核拒绝"
  "data": null
}
```

**业务逻辑**:

**审核通过（status=1）**：
1. 检查订单状态是否为"待处理"
2. 验证handlerId是否提供且负责人是否存在（handlers表）
3. 更新订单状态为"进行中"（1）
4. 记录负责人ID（handler_id）、审核时间（audit_time）和审核人（audit_by，当前登录的管理员）

**审核拒绝（status=2）**：
1. 检查订单状态是否为"待处理"
2. 验证rejectReason是否提供
3. 更新订单状态为"已拒绝"（2）
4. 记录拒绝原因、审核时间和审核人

**权限要求**: `reagent_order:audit`

**说明**: 统一审核接口，通过status参数区分通过/拒绝，减少接口数量，统一审核逻辑处理。

---

### 1.7 完成试剂耗材订购订单
**接口地址**: `PUT /api/support/reagent-orders/:id/complete`

**响应数据**:
```json
{
  "code": 200,
  "message": "订单已完成",
  "data": null
}
```

**业务逻辑**:
1. 检查订单状态是否为"进行中"
2. 更新订单状态为"已完成"（3）
3. 记录完成时间

**权限要求**: `reagent_order:complete`

---

### 1.8 取消试剂耗材订购订单
**接口地址**: `PUT /api/support/reagent-orders/:id/cancel`

**响应数据**:
```json
{
  "code": 200,
  "message": "订单已取消",
  "data": null
}
```

**业务逻辑**:
1. 只允许取消状态为"进行中"的订单
2. 更新订单状态为"已取消"（4）

**权限要求**: `reagent_order:cancel`

---

## 2. 试剂耗材品牌管理接口

### 2.1 品牌列表
**接口地址**: `GET /api/support/reagent-brands`

**请求参数**:
```json
{
  "page": 1,          // 页码
  "pageSize": 10,     // 每页数量
  "name": "Thermo"    // 可选，品牌名称模糊查询
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "Thermo Fisher",
        "created_at": "2026-01-01 00:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
```

**权限要求**: `reagent_brand:list`

---

### 2.2 创建品牌
**接口地址**: `POST /api/support/reagent-brands`

**请求参数**:
```json
{
  "name": "Thermo Fisher"  // 必填，品牌名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "name": "Thermo Fisher",
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证品牌名称唯一性

**权限要求**: `reagent_brand:create`

---

### 2.3 更新品牌
**接口地址**: `PUT /api/support/reagent-brands/:id`

**请求参数**:
```json
{
  "name": "Thermo Fisher Scientific"  // 必填，品牌名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 验证新品牌名称唯一性

**权限要求**: `reagent_brand:update`

---

### 2.4 删除品牌
**接口地址**: `DELETE /api/support/reagent-brands/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有订单使用此品牌，有则不允许删除
2. 物理删除

**权限要求**: `reagent_brand:delete`

---

### 2.5 品牌详情
**接口地址**: `GET /api/support/reagent-brands/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "Thermo Fisher",
    "created_at": "2026-01-01 00:00:00",
    "updated_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `reagent_brand:detail`

---

### 2.6 获取品牌选项列表
**接口地址**: `GET /api/support/reagent-brands/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "Thermo Fisher"
    },
    {
      "id": 2,
      "name": "Sigma-Aldrich"
    }
  ]
}
```

**说明**: 返回所有品牌，用于下拉选择

**权限要求**: 无（已登录即可）

---

## 3. 试剂耗材规格管理接口

### 3.1 规格列表
**接口地址**: `GET /api/support/reagent-specifications`

**请求参数**:
```json
{
  "page": 1,          // 页码
  "pageSize": 10,     // 每页数量
  "name": "100"       // 可选，规格名称模糊查询
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "100次/盒",
        "created_at": "2026-01-01 00:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
```

**权限要求**: `reagent_specification:list`

---

### 3.2 创建规格
**接口地址**: `POST /api/support/reagent-specifications`

**请求参数**:
```json
{
  "name": "100次/盒"  // 必填，规格名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "name": "100次/盒",
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证规格名称唯一性

**权限要求**: `reagent_specification:create`

---

### 3.3 更新规格
**接口地址**: `PUT /api/support/reagent-specifications/:id`

**请求参数**:
```json
{
  "name": "200次/盒"  // 必填，规格名称
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 验证新规格名称唯一性

**权限要求**: `reagent_specification:update`

---

### 3.4 删除规格
**接口地址**: `DELETE /api/support/reagent-specifications/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有订单使用此规格，有则不允许删除
2. 物理删除

**权限要求**: `reagent_specification:delete`

---

### 3.5 规格详情
**接口地址**: `GET /api/support/reagent-specifications/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "100次/盒",
    "created_at": "2026-01-01 00:00:00",
    "updated_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `reagent_specification:detail`

---

### 3.6 获取规格选项列表
**接口地址**: `GET /api/support/reagent-specifications/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "100次/盒"
    },
    {
      "id": 2,
      "name": "500ml/瓶"
    }
  ]
}
```

**说明**: 返回所有规格，用于下拉选择

**权限要求**: 无（已登录即可）

---

## 4. 统计接口

> ⚠️ **说明**：统计接口为**非核心功能**，当前版本暂未实现。这些接口将在后续版本中根据需求实现。

### 4.1 试剂耗材订购统计
**接口地址**: `GET /api/support/reagent-orders/statistics`

**请求参数**:
```json
{
  "startDate": "2026-01-01",  // 可选，统计开始日期
  "endDate": "2026-01-31"     // 可选，统计结束日期
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,           // 总订单数
    "pending": 10,          // 待处理
    "inProgress": 30,       // 进行中
    "rejected": 5,          // 已拒绝
    "completed": 50,        // 已完成
    "cancelled": 5,         // 已取消
    "brandRanking": [       // 品牌订购排行
      {
        "brandId": 1,
        "brandName": "Thermo Fisher",
        "count": 40
      }
    ]
  }
}
```

**权限要求**: `reagent_order:statistics`

