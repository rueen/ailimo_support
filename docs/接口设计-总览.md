# Ailimo Service - 接口设计总览

## 文档结构说明

为了便于阅读和维护，接口设计文档已按功能模块拆分为以下文件：

### 管理端接口（前缀：`/api/support/`）
1. **接口设计-管理端-认证与权限.md** - 登录、权限管理
2. **接口设计-管理端-用户管理.md** - 用户、组织机构、课题组管理
3. **接口设计-管理端-设备预约.md** - 设备预约订单、设备管理、时间配置
4. **接口设计-管理端-笼位预约.md** - 笼位预约订单、笼位管理、用途管理
5. **接口设计-管理端-实验代操作.md** - 实验代操作订单、操作内容管理
6. **接口设计-管理端-动物订购.md** - 动物订购订单、品牌/品系/规格管理
7. **接口设计-管理端-试剂耗材.md** - 试剂耗材订购、品牌/规格管理
8. **接口设计-管理端-内容管理.md** - 案例管理、公司信息、通用配置

### 用户端接口（前缀：`/api/h5/`）
9. **接口设计-用户端.md** - 所有用户端接口

## 接口通用规范

### 1. 请求格式
- **Content-Type**: `application/json`
- **编码**: UTF-8

### 2. 响应格式（统一）
```json
{
  "code": 200,          // 状态码：200-成功 400-参数错误 401-未授权 403-无权限 500-服务器错误
  "message": "success", // 提示信息
  "data": {}           // 响应数据
}
```

### 3. 分页参数（统一）
所有列表接口的请求参数：
```json
{
  "page": 1,           // 页码，从1开始
  "pageSize": 10       // 每页数量，默认10
}
```

所有列表接口的响应格式：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [],        // 数据列表
    "total": 100,      // 总记录数
    "page": 1,         // 当前页码
    "pageSize": 10,    // 每页数量
    "totalPages": 10   // 总页数
  }
}
```

### 4. 身份验证
- **管理端**：使用JWT Token，通过请求头 `Authorization: Bearer <token>` 传递
- **用户端**：使用JWT Token，通过请求头 `Authorization: Bearer <token>` 传递

### 5. 常见状态码说明
| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 参数错误 |
| 401 | 未登录/Token失效 |
| 403 | 无权限访问 |
| 404 | 资源不存在 |
| 429 | 请求频率超限 |
| 500 | 服务器内部错误 |

### 6. 字段命名规范
**统一使用下划线命名（snake_case）**，与数据库字段保持一致：
- ✅ 正确：`created_at`, `updated_at`, `organization_id`, `audit_status`, `audit_time`, `audit_by`, `reject_reason`
- ❌ 错误：`createdAt`, `updatedAt`, `organizationId`, `auditStatus`, `auditTime`, `auditBy`, `rejectReason`

**说明**：
- 数据库使用下划线命名（`underscored: true`）
- API 响应字段统一使用下划线命名，与数据库字段保持一致
- 前端接收和发送数据时需使用下划线命名格式

### 7. 时间格式
- **日期**: `YYYY-MM-DD` 例如：2026-01-07
- **日期时间**: `YYYY-MM-DD HH:mm:ss` 例如：2026-01-07 15:30:00
- **时间**: `HH:mm` 或 `HH:mm:ss` 例如：09:00 或 09:00:00

### 8. 订单状态说明
#### 预约类订单（设备预约、笼位预约、实验代操作）
- `0` - 待审核
- `1` - 进行中（审核通过）
- `2` - 已拒绝
- `3` - 已完成
- `4` - 已取消

#### 订购类订单（动物订购、试剂耗材订购）
- `0` - 待处理
- `1` - 进行中（审核通过）
- `2` - 已拒绝
- `3` - 已完成
- `4` - 已取消

### 9. 用户审核状态
- `0` - 待审核
- `1` - 审核通过
- `2` - 审核拒绝

### 10. 性别枚举
- `0` - 雌性
- `1` - 雄性
- `2` - 不限

### 11. 数据验证规则
- **手机号**: 11位数字，1开头
- **验证码**: 6位数字
- **密码**: 6-20位，包含字母和数字
- **日期**: 符合 YYYY-MM-DD 格式
- **必填项**: 不能为空或null

### 12. 安全机制
- ✅ 所有密码使用bcrypt加密
- ✅ JWT Token过期时间：管理端7天，用户端30天
- ✅ 接口限流：同一IP每分钟最多100次请求
- ✅ 短信验证码：5分钟有效期，每天同一手机号最多发送10次
- ✅ 参数校验：使用express-validator进行参数验证
- ✅ SQL注入防护：使用参数化查询
- ✅ XSS防护：对输入内容进行过滤
- ✅ CORS配置：仅允许指定域名访问

### 13. 文件上传
- **图片格式**: jpg, jpeg, png, gif, webp
- **图片大小**: 单个文件最大5MB
- **存储方式**: 阿里云OSS（配置预留）
- **返回格式**: OSS完整URL地址

### 14. 权限控制
管理端接口采用RBAC（基于角色的访问控制）：
- 每个负责人账号关联一个角色
- 每个角色拥有多个权限
- 每个权限对应具体的接口路由和方法
- 接口调用前验证当前用户是否有对应权限

### 15. 错误处理
所有接口都应该捕获并处理以下错误：
- 参数验证错误
- 数据库操作错误
- 业务逻辑错误
- 系统异常错误

错误响应示例：
```json
{
  "code": 400,
  "message": "手机号格式不正确",
  "data": null
}
```

## 接口开发注意事项

1. **事务处理**: 涉及多表操作的接口必须使用事务，确保数据一致性
2. **并发控制**: 库存扣减等操作需要加锁防止超卖
3. **日志记录**: 记录关键操作日志（审核、取消、完成等）
4. **性能优化**: 
   - 使用索引优化查询
   - 避免N+1查询问题
   - 对于复杂查询考虑使用缓存
5. **数据脱敏**: 返回给前端的敏感数据需要脱敏（如部分隐藏手机号）
6. **软删除**: 重要数据使用软删除，不进行物理删除

## 下一步
请依次查看各个模块的详细接口设计文档。

