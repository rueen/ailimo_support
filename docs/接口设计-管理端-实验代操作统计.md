# 管理端接口 - 实验代操作统计

## 基础路径
```
/api/support
```

## 1. 实验代操作统计接口

### 1.1 获取代操作统计数据
**接口地址**: `GET /api/support/experiment-operations/statistics`

**功能说明**: 
- 统计指定时间范围内，每天每个用户各种操作类型的动物数量
- 只统计**已完成**状态的订单
- 统计基于订单的**完成日期**
- 用于月底与用户结算代操作费用

**请求参数**:
```json
{
  "start_date": "2024-12-01",  // 必填，统计开始日期（YYYY-MM-DD）
  "end_date": "2024-12-31"     // 必填，统计结束日期（YYYY-MM-DD）
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "dates": [
      "2024-12-01",
      "2024-12-02",
      "2024-12-03"
    ],
    "users": [
      {
        "id": 1,
        "name": "潘宗友",
        "operations": [
          {
            "id": 1,
            "name": "乱笼分笼"
          },
          {
            "id": 2,
            "name": "耳标"
          },
          {
            "id": 3,
            "name": "剪尾"
          }
        ]
      },
      {
        "id": 2,
        "name": "陈荣芹",
        "operations": [
          {
            "id": 4,
            "name": "建育"
          },
          {
            "id": 5,
            "name": "废胎注射"
          }
        ]
      }
    ],
    "data": {
      "2024-12-01_1_1": 6,     // 日期_用户ID_操作类型ID: 动物数量
      "2024-12-01_1_2": 23,
      "2024-12-02_1_1": 6,
      "2024-12-02_1_2": 23,
      "2024-12-03_2_5": 15
    }
  }
}
```

**数据结构说明**:

1. **dates**: 日期数组，包含时间范围内的所有日期（按升序排列）
2. **users**: 用户数组，包含在此时间范围内有已完成订单的所有用户
   - `id`: 用户ID
   - `name`: 用户姓名
   - `operations`: 该用户在此时间范围内涉及的所有操作类型
     - `id`: 操作类型ID（operation_content表）
     - `name`: 操作类型名称
3. **data**: 统计数据对象
   - **key格式**: `{日期}_{用户ID}_{操作类型ID}`
   - **value**: 该日期、该用户、该操作类型的动物数量总和
   - 只包含有数据的项（值为0或没有数据的不返回）

**业务逻辑**:

1. **查询条件**:
   - 订单状态 = 已完成（status = 3）
   - 完成日期（completed_time）在 start_date 和 end_date 之间
   
2. **统计规则**:
   - 按完成日期（completed_time的日期部分）分组
   - 按用户ID分组
   - 按操作类型ID分组
   - 对每组的动物数量（quantity）求和
   
3. **数据组织**:
   - dates数组包含从start_date到end_date的所有日期（不管是否有数据）
   - users数组只包含在此时间范围内有已完成订单的用户
   - 每个用户的operations数组只包含该用户在此时间范围内涉及的操作类型
   - data对象只包含有数据的统计项（避免返回大量0值）

4. **排序规则**:
   - dates：按日期升序
   - users：按用户ID升序（或按用户姓名拼音排序）
   - operations：按操作类型ID升序（或按操作类型名称排序）

**权限要求**: `experiment_operation:statistics`

---

## 2. 前端使用说明

### 2.1 统计表格展示

前端根据返回数据渲染表格：

**表头结构**:
- 第一行：日期 | 用户1（跨操作类型列数） | 用户2（跨操作类型列数） | ... | 合计
- 第二行：空 | 操作类型1 | 操作类型2 | ... | 操作类型1 | 操作类型2 | ... | 空

**数据行**:
- 每一行对应一个日期
- 每个单元格通过 `data["{日期}_{用户ID}_{操作类型ID}"]` 获取数值
- 如果key不存在，显示为空

**小计行**:
- 每列的小计 = 该列所有日期的数据之和
- 合计列 = 所有数据的总和

**周末高亮**:
- 使用dayjs判断日期是否为周六或周日
- 周末行添加黄色背景

### 2.2 导出Excel

前端使用 `xlsx` 库导出Excel，需要：

1. 安装依赖:
```bash
npm install xlsx
```

2. 导出时构建二维数组，保持表格结构
3. 设置合并单元格（用户名跨多列）
4. 设置样式（周末行高亮、小计行加粗等）

---

## 3. 后端实现建议

### 3.1 SQL查询示例（伪代码）

```sql
-- 1. 查询指定时间范围内已完成的订单
SELECT 
  DATE(completed_time) as date,
  user_id,
  operation_content_id,
  SUM(quantity) as total_quantity
FROM experiment_operations
WHERE status = 3 
  AND DATE(completed_time) >= :start_date
  AND DATE(completed_time) <= :end_date
GROUP BY DATE(completed_time), user_id, operation_content_id
ORDER BY date ASC, user_id ASC, operation_content_id ASC

-- 2. 查询涉及的用户信息
SELECT DISTINCT u.id, u.name
FROM experiment_operations eo
JOIN users u ON eo.user_id = u.id
WHERE eo.status = 3 
  AND DATE(eo.completed_time) >= :start_date
  AND DATE(eo.completed_time) <= :end_date
ORDER BY u.id ASC

-- 3. 查询每个用户涉及的操作类型
SELECT DISTINCT eo.user_id, oc.id, oc.name
FROM experiment_operations eo
JOIN operation_contents oc ON eo.operation_content_id = oc.id
WHERE eo.status = 3 
  AND DATE(eo.completed_time) >= :start_date
  AND DATE(eo.completed_time) <= :end_date
ORDER BY eo.user_id ASC, oc.id ASC
```

### 3.2 数据组装

1. 生成dates数组（从start_date到end_date的所有日期）
2. 查询users及其operations
3. 查询统计数据，组装成 `{date_userId_operationId: quantity}` 格式
4. 返回JSON

### 3.3 性能优化

- 对于大数据量，建议添加索引：
  - `experiment_operations(status, completed_time)`
  - `experiment_operations(user_id, operation_content_id, completed_time)`
- 如果时间范围过大（如超过3个月），可以考虑分页或限制

---

## 4. 示例场景

**场景**: 统计2024年12月的代操作数据

**请求**:
```
GET /api/support/experiment-operations/statistics?start_date=2024-12-01&end_date=2024-12-31
```

**假设数据**:
- 12月1日：潘宗友完成"乱笼分笼"6只、"耳标"23只
- 12月2日：潘宗友完成"乱笼分笼"6只、"耳标"23只
- 12月3日：陈荣芹完成"废胎注射"15只

**返回数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "dates": ["2024-12-01", "2024-12-02", ..., "2024-12-31"],
    "users": [
      {
        "id": 1,
        "name": "潘宗友",
        "operations": [
          {"id": 1, "name": "乱笼分笼"},
          {"id": 2, "name": "耳标"}
        ]
      },
      {
        "id": 2,
        "name": "陈荣芹",
        "operations": [
          {"id": 5, "name": "废胎注射"}
        ]
      }
    ],
    "data": {
      "2024-12-01_1_1": 6,
      "2024-12-01_1_2": 23,
      "2024-12-02_1_1": 6,
      "2024-12-02_1_2": 23,
      "2024-12-03_2_5": 15
    }
  }
}
```

**前端表格展示**:

| 日期 | 潘宗友 | 潘宗友 | 陈荣芹 | 合计 |
|------|--------|--------|--------|------|
|      | 乱笼分笼 | 耳标 | 废胎注射 |      |
| 12.1 | 6      | 23     |        | 29   |
| 12.2 | 6      | 23     |        | 29   |
| 12.3 |        |        | 15     | 15   |
| ...  | ...    | ...    | ...    | ...  |
| 小计 | 12     | 46     | 15     | 73   |

---

## 5. 注意事项

1. **日期范围验证**:
   - start_date 必须小于等于 end_date
   - 建议限制时间范围不超过1年
   
2. **数据量控制**:
   - 如果用户数或操作类型数过多，前端表格可能过宽
   - 建议前端实现横向滚动
   
3. **空数据处理**:
   - 如果时间范围内没有已完成订单，返回空的users数组和data对象
   - dates数组仍然包含所有日期
   
4. **权限控制**:
   - 需要配置 `experiment_operation:statistics` 权限
   - 建议只有管理员和财务人员有此权限
   
5. **价格信息**:
   - 当前版本不包含价格信息（私下结算）
   - 如果未来需要在系统中配置价格，可以在operation_contents表添加price字段

---

## 6. 未来扩展建议

1. **按用户筛选**: 添加user_id参数，只统计指定用户的数据
2. **按操作类型筛选**: 添加operation_content_id参数
3. **价格统计**: 添加price字段，返回金额统计
4. **图表展示**: 返回额外的汇总数据用于图表展示
5. **导出接口**: 提供后端导出Excel接口，减轻前端压力
