# 管理端接口 - 设备预约管理

## 基础路径
```
/api/support
```

## 1. 设备预约订单管理接口

### 1.1 设备预约订单列表
**接口地址**: `GET /api/support/equipment-reservations`

**请求参数**:
```json
{
  "page": 1,              // 页码
  "page_size": 10,         // 每页数量
  "equipment_id": 1,       // 可选，设备ID筛选
  "equipment_name": "显微镜", // 可选，设备名称模糊查询
  "user_name": "张三",     // 可选，预约用户姓名模糊查询
  "user_phone": "138",     // 可选，预约用户手机号模糊查询
  "status": 0,            // 可选，状态筛选：0-待审核 1-进行中 2-已拒绝 3-已完成 4-已取消
  "reservation_date": "2026-01-10",  // 可选，预约日期筛选
  "start_date": "2026-01-01",        // 可选，预约日期范围开始
  "end_date": "2026-01-31"           // 可选，预约日期范围结束
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "equipment": {
          "id": 1,
          "name": "高倍显微镜"
        },
        "user": {
          "id": 10,
          "name": "张三",
          "phone": "13800138000"
        },
        "reservation_date": "2026-01-10",
        "time_slots": ["09:00-10:00", "10:00-11:00"],
        "status": 0,
        "remark": "需要使用显微镜进行细胞观察",
        "handler": null,
        "reject_reason": null,
        "audit_time": null,
        "audit_by": null,
        "completed_time": null,
        "created_at": "2026-01-07 10:00:00"
      },
      {
        "id": 2,
        "equipment": {
          "id": 2,
          "name": "离心机"
        },
        "user": {
          "id": 11,
          "name": "李四",
          "phone": "13900139000"
        },
        "reservation_date": "2026-01-12",
        "time_slots": ["14:00-15:00"],
        "status": 1,
        "remark": null,
        "handler": {
          "id": 1,
          "name": "王负责人"
        },
        "reject_reason": null,
        "audit_time": "2026-01-08 09:30:00",
        "audit_by": {
          "id": 1,
          "username": "admin"
        },
        "completed_time": null,
        "created_at": "2026-01-08 08:00:00"
      }
    ],
    "total": 50,
    "page": 1,
    "page_size": 10,
    "total_pages": 5
  }
}
```

**权限要求**: `equipment_reservation:list`

---

### 1.2 设备预约订单详情
**接口地址**: `GET /api/support/equipment-reservations/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "equipment": {
      "id": 1,
      "name": "高倍显微镜",
      "details": {
        "base_info": "德国进口高倍显微镜",
        "image": ["https://oss.example.com/img1.jpg"]
      }
    },
    "user": {
      "id": 10,
      "name": "张三",
      "phone": "13800138000",
      "organization": {
        "id": 1,
        "name": "浙江大学"
      }
    },
    "reservation_date": "2026-01-10",
    "time_slots": ["09:00-10:00", "10:00-11:00"],
    "status": 1,
    "remark": "需要使用显微镜进行细胞观察",
    "handler": {
      "id": 2,
      "username": "zhangsan",
      "remark": "设备管理员"
    },
    "reject_reason": null,
    "audit_time": "2026-01-07 15:00:00",
    "audit_by": {
      "id": 1,
      "username": "admin"
    },
    "completed_time": null,
    "created_at": "2026-01-07 10:00:00",
    "updated_at": "2026-01-07 15:00:00"
  }
}
```

**权限要求**: `equipment_reservation:detail`

---

### 1.3 新增设备预约订单
**接口地址**: `POST /api/support/equipment-reservations`

**请求参数**:
```json
{
  "equipment_id": 1,                              // 必填，设备ID
  "user_id": 10,                                  // 必填，预约用户ID
  "reservation_date": "2026-01-10",               // 必填，预约日期
  "time_slots": ["09:00-10:00", "10:00-11:00"],  // 必填，预约时间段数组
  "remark": "需要使用显微镜进行细胞观察"         // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 20,
    "equipment_id": 1,
    "user_id": 10,
    "reservation_date": "2026-01-10",
    "time_slots": ["09:00-10:00", "10:00-11:00"],
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证设备是否存在且启用
2. 验证用户是否存在且审核通过
3. 验证预约日期不能是过去的日期
4. 验证预约日期不能超过提前预约天数限制
5. 验证时间段格式和有效性
6. **检查设备在选定时间段是否已被预约（使用数据库行锁防止并发）**
7. 创建订单

**权限要求**: `equipment_reservation:create`

---

### 1.4 编辑设备预约订单
**接口地址**: `PUT /api/support/equipment-reservations/:id`

**请求参数**:
```json
{
  "equipment_id": 1,                              // 可选，设备ID
  "user_id": 10,                                  // 可选，预约用户ID
  "reservation_date": "2026-01-10",               // 可选，预约日期
  "time_slots": ["09:00-10:00", "10:00-11:00"],  // 可选，预约时间段数组
  "remark": "备注信息"                           // 可选，备注
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 只允许编辑状态为"待审核"的订单
2. 如果修改设备、日期或时间段，需要重新验证设备可用性
3. 验证逻辑同创建订单

**权限要求**: `equipment_reservation:update`

---

### 1.5 审核设备预约订单
**接口地址**: `PUT /api/support/equipment-reservations/:id/audit`

**请求参数**:
```json
{
  "status": 1,                    // 必填，审核状态：1-通过 2-拒绝
  "handler_id": 2,                 // 通过时必填，负责人ID
  "reject_reason": "拒绝原因"      // 拒绝时必填，拒绝原因
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "审核通过",  // 或 "审核拒绝"
  "data": null
}
```

**业务逻辑**:

**审核通过（status=1）**：
1. 检查订单状态是否为"待审核"
2. 验证handlerId是否提供且负责人是否存在（handlers表）
3. **再次检查设备时间段是否可用（防止并发审核导致冲突）**：
   - 查询该设备在该日期已审核通过（status=1）或已完成（status=3）的订单（排除当前订单）
   - 检查所选时间段是否与已有订单的时间段冲突
   - 如果冲突，返回错误提示"该时间段设备已被预约"
4. **占用设备时间段**：审核通过后，该设备在该日期该时间段被占用（通过订单状态为"进行中"来标识占用）
5. 更新订单状态为"进行中"（1）
6. 记录负责人ID（handler_id）、审核时间（audit_time）和审核人（audit_by，当前登录的管理员）

**审核拒绝（status=2）**：
1. 检查订单状态是否为"待审核"
2. 验证rejectReason是否提供
3. **释放设备时间段**：由于订单是"待审核"状态，尚未占用设备，所以无需释放（订单状态为"进行中"或"已完成"时才占用设备）
4. 更新订单状态为"已拒绝"（2）
5. 记录拒绝原因、审核时间和审核人

**权限要求**: `equipment_reservation:audit`

**说明**: 统一审核接口，通过status参数区分通过/拒绝，减少接口数量，统一审核逻辑处理。

---

### 1.7 完成设备预约订单
**接口地址**: `PUT /api/support/equipment-reservations/:id/complete`

**响应数据**:
```json
{
  "code": 200,
  "message": "订单已完成",
  "data": null
}
```

**业务逻辑**:
1. 检查订单状态是否为"进行中"
2. **释放设备时间段**：订单完成后，该设备在该日期该时间段被释放，可供其他订单使用
3. 更新订单状态为"已完成"（3）
4. 记录完成时间（completed_time）

**权限要求**: `equipment_reservation:complete`

---

### 1.8 取消设备预约订单
**接口地址**: `PUT /api/support/equipment-reservations/:id/cancel`

**响应数据**:
```json
{
  "code": 200,
  "message": "订单已取消",
  "data": null
}
```

**业务逻辑**:
1. 只允许取消状态为"进行中"的订单
2. **释放设备时间段**：取消订单后，该设备在该日期该时间段被释放，可供其他订单使用
3. 更新订单状态为"已取消"（4）

**权限要求**: `equipment_reservation:cancel`

---

## 2. 设备管理接口

### 2.1 设备列表
**接口地址**: `GET /api/support/equipment`

**请求参数**:
```json
{
  "page": 1,          // 页码
  "page_size": 10,     // 每页数量
  "name": "显微镜",   // 可选，设备名称模糊查询
  "status": 1         // 可选，状态筛选：0-禁用 1-启用
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "高倍显微镜",
        "details": {
          "base_info": "德国进口高倍显微镜",
          "image": ["https://oss.example.com/img1.jpg"],
          "specs": "放大倍数1000倍"
        },
        "status": 1,
        "created_at": "2026-01-01 00:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "page_size": 10,
    "total_pages": 1
  }
}
```

**权限要求**: `equipment:list`

---

### 2.2 创建设备
**接口地址**: `POST /api/support/equipment`

**请求参数**:
```json
{
  "name": "高倍显微镜",  // 必填，设备名称
  "details": {           // 可选，设备详情（JSON格式）
    "base_info": "德国进口高倍显微镜",
    "image": ["https://oss.example.com/img1.jpg"],
    "specs": "放大倍数1000倍"
  }
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "name": "高倍显微镜",
    "details": {...},
    "status": 1,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**权限要求**: `equipment:create`

---

### 2.3 更新设备
**接口地址**: `PUT /api/support/equipment/:id`

**请求参数**:
```json
{
  "name": "超高倍显微镜",  // 可选，设备名称
  "details": {             // 可选，设备详情
    "base_info": "德国进口超高倍显微镜",
    "image": ["https://oss.example.com/img2.jpg"]
  },
  "status": 1              // 可选，状态
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**权限要求**: `equipment:update`

---

### 2.4 删除设备
**接口地址**: `DELETE /api/support/equipment/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有未完成的预约订单，有则不允许删除
2. 物理删除

**权限要求**: `equipment:delete`

---

### 2.5 设备详情
**接口地址**: `GET /api/support/equipment/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "高倍显微镜",
    "details": {
      "base_info": "德国进口高倍显微镜",
      "image": ["https://oss.example.com/img1.jpg"],
      "specs": "放大倍数1000倍"
    },
    "status": 1,
    "created_at": "2026-01-01 00:00:00",
    "updated_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `equipment:detail`

---

### 2.6 获取设备选项列表
**接口地址**: `GET /api/support/equipment/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "高倍显微镜"
    },
    {
      "id": 2,
      "name": "离心机"
    }
  ]
}
```

**说明**: 返回所有启用状态的设备，用于下拉选择

**权限要求**: 无（已登录即可）

---

### 2.7 查询设备可用时间段
**接口地址**: `GET /api/support/equipment/:id/available-slots`

**请求参数**:
```json
{
  "date": "2026-01-10"  // 必填，查询日期
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "startTime": "09:00:00",
      "endTime": "10:00:00",
      "display_time": "09:00-10:00",
      "description": "上午时段1",
      "available": false
    },
    {
      "id": 2,
      "startTime": "10:00:00",
      "endTime": "11:00:00",
      "display_time": "10:00-11:00",
      "description": "上午时段2",
      "available": false
    },
    {
      "id": 3,
      "startTime": "11:00:00",
      "endTime": "12:00:00",
      "display_time": "11:00-12:00",
      "description": "上午时段3",
      "available": true
    },
    {
      "id": 4,
      "startTime": "13:00:00",
      "endTime": "14:00:00",
      "display_time": "13:00-14:00",
      "description": "下午时段1",
      "available": true
    }
  ]
}
```

**字段说明**:
- `id`: 时间段ID
- `startTime`: 开始时间
- `endTime`: 结束时间
- `display_time`: 显示时间（格式：HH:MM-HH:MM）
- `description`: 时间段描述
- `available`: 是否可用（true-可用，false-已被预约）

**业务逻辑**:
1. 查询所有启用的时间段配置（equipment_time_slots表，status=1）
2. 查询该设备在该日期已预约的时间段（状态为待审核或进行中）
3. 计算可用时间段（时间段配置中排除已预约的）

**权限要求**: 无（已登录即可）

---

## 3. 设备预约时间段管理接口

### 3.1 时间段列表
**接口地址**: `GET /api/support/equipment-time-slots`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "start_time": "09:00:00",
      "end_time": "10:00:00",
      "display_time": "9:00-10:00",
      "description": "",
      "status": 1,
      "sort_order": 1
    },
    {
      "id": 2,
      "start_time": "10:00:00",
      "end_time": "11:00:00",
      "display_time": "10:00-11:00",
      "description": "",
      "status": 1,
      "sort_order": 2
    }
  ]
}
```

**说明**: 返回所有时间段配置，按sort_order排序

**权限要求**: `equipment_time_slot:list`

---

### 3.2 创建时间段
**接口地址**: `POST /api/support/equipment-time-slots`

**请求参数**:
```json
{
  "start_time": "09:00:00",    // 必填，开始时间
  "end_time": "10:00:00",      // 必填，结束时间
  "description": "",           // 可选，描述/备注
  "status": 1,                // 可选，状态：0-禁用 1-启用，默认1
  "sort_order": 1              // 可选，排序，默认0
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 10,
    "start_time": "09:00:00",
    "end_time": "10:00:00",
    "description": "",
    "status": 1,
    "sort_order": 1,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

**业务逻辑**:
1. 验证时间格式
2. 验证开始时间必须小于结束时间
3. 检查时间段是否与已有时间段冲突

**权限要求**: `equipment_time_slot:create`

---

### 3.3 更新时间段
**接口地址**: `PUT /api/support/equipment-time-slots/:id`

**请求参数**:
```json
{
  "start_time": "09:00:00",    // 可选，开始时间
  "end_time": "10:00:00",      // 可选，结束时间
  "description": "",           // 可选，描述/备注
  "status": 1,                // 可选，状态
  "sort_order": 1              // 可选，排序
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**业务逻辑**:
1. 验证时间格式
2. 验证开始时间必须小于结束时间
3. 检查时间段是否与其他时间段冲突

**权限要求**: `equipment_time_slot:update`

---

### 3.4 删除时间段
**接口地址**: `DELETE /api/support/equipment-time-slots/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**业务逻辑**:
1. 检查是否有订单使用此时间段，有则不允许删除
2. 物理删除

**权限要求**: `equipment_time_slot:delete`

---

### 3.5 时间段详情
**接口地址**: `GET /api/support/equipment-time-slots/:id`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "start_time": "09:00:00",
    "end_time": "10:00:00",
    "description": "",
    "status": 1,
    "sort_order": 1,
    "created_at": "2026-01-01 00:00:00",
    "updated_at": "2026-01-01 00:00:00"
  }
}
```

**权限要求**: `equipment_time_slot:detail`

---

### 3.6 获取时间段选项列表
**接口地址**: `GET /api/support/equipment-time-slots/options`

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "start_time": "09:00:00",
      "end_time": "10:00:00",
      "display_time": "9:00-10:00",
      "description": "",
      "status": 1
    }
  ]
}
```

**说明**: 返回所有启用的时间段配置，用于前端多选，按sort_order排序

**权限要求**: 无（已登录即可）

---

### 3.7 提前预约天数配置

**说明**: 设备预约提前预约天数配置使用统一的系统配置接口，请参考《接口设计-管理端-内容管理.md》中的"系统配置管理接口"章节。

**获取配置**: 使用 `GET /api/support/advance-days` 统一接口，返回所有模块的提前预约天数配置（包含equipment_advance_days字段）

**更新配置**: 使用 `PUT /api/support/system-configs/equipment_advance_days` 接口更新配置值

---

## 4. 统计接口

> ⚠️ **说明**：统计接口为**非核心功能**，当前版本暂未实现。这些接口将在后续版本中根据需求实现。

### 4.1 设备预约统计
**接口地址**: `GET /api/support/equipment-reservations/statistics`

**请求参数**:
```json
{
  "start_date": "2026-01-01",  // 可选，统计开始日期
  "end_date": "2026-01-31"     // 可选，统计结束日期
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,           // 总订单数
    "pending": 10,          // 待审核
    "inProgress": 30,       // 进行中
    "rejected": 5,          // 已拒绝
    "completed": 50,        // 已完成
    "cancelled": 5,         // 已取消
    "equipmentRanking": [   // 设备使用排行
      {
        "equipment_id": 1,
        "equipment_name": "高倍显微镜",
        "count": 30
      }
    ]
  }
}
```

**权限要求**: `equipment_reservation:statistics`

