# 前端调整指南 - 预约时间段格式变更

> **变更日期**: 2026-01-21  
> **影响范围**: 设备预约、实验代操作模块（管理端 + H5 端）  
> **变更类型**: 数据格式调整（支持跨天预约）

---

## 📋 变更概述

为了支持跨天预约功能，对 **设备预约订单** 和 **实验代操作订单** 的时间段存储格式进行了调整：

- **原格式**: 预约日期与时间段分开存储
- **新格式**: 预约日期与时间段合并存储，一个订单可包含多个日期的时间段

---

## 🔄 数据结构变化

### 1. 设备预约订单（equipment_reservations）

#### 变更前
```json
{
  "id": 1,
  "equipment_id": 1,
  "user_id": 10,
  "reservation_date": "2026-01-10",           // ❌ 已删除
  "time_slots": ["09:00-10:00", "10:00-11:00"], // ⚠️ 格式变更
  "status": 0,
  "remark": "备注",
  "created_at": "2026-01-07 10:00:00"
}
```

#### 变更后
```json
{
  "id": 1,
  "equipment_id": 1,
  "user_id": 10,
  "time_slots": [                              // ✅ 新格式（包含日期）
    "2026-01-10 09:00-10:00",
    "2026-01-10 10:00-11:00",
    "2026-01-11 09:00-10:00"                   // ✅ 支持跨天
  ],
  "status": 0,
  "remark": "备注",
  "created_at": "2026-01-07 10:00:00"
}
```

### 2. 实验代操作订单（experiment_operations）

#### 变更前
```json
{
  "id": 1,
  "operation_content_id": 1,
  "animal_type_id": 1,
  "quantity": 20,
  "user_id": 10,
  "reservation_date": "2026-01-10",           // ❌ 已删除
  "time_slots": ["09:00-12:00", "13:00-18:00"], // ⚠️ 格式变更
  "status": 0,
  "remark": "备注"
}
```

#### 变更后
```json
{
  "id": 1,
  "operation_content_id": 1,
  "animal_type_id": 1,
  "quantity": 20,
  "user_id": 10,
  "time_slots": [                              // ✅ 新格式（包含日期）
    "2026-01-10 09:00-12:00",
    "2026-01-10 13:00-18:00",
    "2026-01-11 09:00-12:00"                   // ✅ 支持跨天
  ],
  "status": 0,
  "remark": "备注"
}
```

---

## 🔌 接口变更详情

### 一、设备预约订单接口

#### 1. 订单列表接口
**接口地址**: `GET /api/support/equipment-reservations`

**变更点**:
- ✅ 请求参数保持不变（`reservation_date`、`start_date`、`end_date` 仍可使用）
- ⚠️ 响应数据中 `reservation_date` 字段已删除
- ⚠️ 响应数据中 `time_slots` 格式变更

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "equipment": {
          "id": 1,
          "name": "高倍显微镜"
        },
        "user": {
          "id": 10,
          "name": "张三",
          "phone": "13800138000"
        },
        "time_slots": [
          "2026-01-10 09:00-10:00",    // 新格式
          "2026-01-10 10:00-11:00"
        ],
        "status": 0,
        "created_at": "2026-01-07 10:00:00"
      }
    ],
    "total": 50,
    "page": 1,
    "page_size": 10
  }
}
```

#### 2. 新增订单接口
**接口地址**: `POST /api/support/equipment-reservations`

**变更点**:
- ❌ 请求参数删除 `reservation_date` 字段
- ⚠️ 请求参数 `time_slots` 格式变更

**请求参数**:
```json
{
  "equipment_id": 1,
  "user_id": 10,
  "time_slots": [                              // 新格式（必须包含日期）
    "2026-01-10 09:00-10:00",
    "2026-01-10 10:00-11:00",
    "2026-01-11 09:00-10:00"                   // 可以跨天
  ],
  "remark": "备注"
}
```

#### 3. 编辑订单接口
**接口地址**: `PUT /api/support/equipment-reservations/:id`

**变更点**: 同新增接口

**请求参数**:
```json
{
  "equipment_id": 1,
  "user_id": 10,
  "time_slots": [
    "2026-01-10 09:00-10:00",
    "2026-01-11 14:00-15:00"
  ],
  "remark": "备注"
}
```

#### 4. 订单详情接口
**接口地址**: `GET /api/support/equipment-reservations/:id`

**变更点**: 同列表接口

#### 5. 查询设备可用时间段接口
**接口地址**: `GET /api/support/equipment/:id/available-slots?date=2026-01-10`

**变更点**:
- ✅ 接口保持不变
- ✅ 请求参数保持不变
- ✅ 响应格式保持不变

**说明**: 该接口仍然按单日查询，但后端会从新格式的 time_slots 中提取指定日期的时间段进行计算。

---

### 二、实验代操作订单接口

#### 1. 订单列表接口
**接口地址**: `GET /api/support/experiment-operations`

**变更点**:
- ✅ 请求参数保持不变
- ⚠️ 响应数据中 `reservation_date` 字段已删除
- ⚠️ 响应数据中 `time_slots` 格式变更

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "operation_content": {
          "id": 1,
          "name": "灌胃"
        },
        "animal_type": {
          "id": 1,
          "name": "小鼠"
        },
        "quantity": 20,
        "user": {
          "id": 10,
          "name": "张三",
          "phone": "13800138000"
        },
        "time_slots": [
          "2026-01-10 09:00-12:00",    // 新格式
          "2026-01-11 09:00-12:00"     // 支持跨天
        ],
        "status": 0,
        "created_at": "2026-01-07 10:00:00"
      }
    ],
    "total": 50,
    "page": 1,
    "page_size": 10
  }
}
```

#### 2. 新增订单接口
**接口地址**: `POST /api/support/experiment-operations`

**变更点**:
- ❌ 请求参数删除 `reservation_date` 字段
- ⚠️ 请求参数 `time_slots` 格式变更

**请求参数**:
```json
{
  "operation_content_id": 1,
  "animal_type_id": 1,
  "quantity": 20,
  "user_id": 10,
  "time_slots": [                              // 新格式（必须包含日期）
    "2026-01-10 09:00-12:00",
    "2026-01-10 13:00-18:00",
    "2026-01-11 09:00-12:00"                   // 可以跨天
  ],
  "remark": "备注"
}
```

#### 3. 编辑订单接口
**接口地址**: `PUT /api/support/experiment-operations/:id`

**变更点**: 同新增接口

#### 4. 订单详情接口
**接口地址**: `GET /api/support/experiment-operations/:id`

**变更点**: 同列表接口

---

## 三、H5 用户端接口变更

### 1. 提交设备预约订单接口
**接口地址**: `POST /api/h5/equipment-orders`

**变更点**:
- ❌ 请求参数删除 `reservation_date` 字段
- ⚠️ 请求参数 `time_slots` 格式变更

**请求参数**:
```json
{
  "equipment_id": 1,
  "time_slots": [                              // 新格式（必须包含日期）
    "2026-01-10 09:00-10:00",
    "2026-01-10 10:00-11:00",
    "2026-01-11 09:00-10:00"                   // 可以跨天
  ],
  "remark": "备注"
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "提交成功，请等待审核",
  "data": {
    "id": 20,
    "equipment_id": 1,
    "time_slots": [
      "2026-01-10 09:00-10:00",
      "2026-01-10 10:00-11:00",
      "2026-01-11 09:00-10:00"
    ],
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

---

### 2. 提交实验代操作订单接口
**接口地址**: `POST /api/h5/experiment-orders`

**变更点**:
- ❌ 请求参数删除 `reservation_date` 字段
- ⚠️ 请求参数 `time_slots` 格式变更

**请求参数**:
```json
{
  "operation_content_id": 1,
  "animal_type_id": 1,
  "quantity": 20,
  "time_slots": [                              // 新格式（必须包含日期）
    "2026-01-10 09:00-12:00",
    "2026-01-10 13:00-18:00",
    "2026-01-11 09:00-12:00"                   // 可以跨天
  ],
  "remark": "备注"
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "提交成功，请等待审核",
  "data": {
    "id": 20,
    "operation_content_id": 1,
    "animal_type_id": 1,
    "quantity": 20,
    "time_slots": [
      "2026-01-10 09:00-12:00",
      "2026-01-10 13:00-18:00",
      "2026-01-11 09:00-12:00"
    ],
    "status": 0,
    "created_at": "2026-01-07 16:00:00"
  }
}
```

---

### 3. 我的订单列表接口
**接口地址**: `GET /api/h5/my-orders`

**变更点**:
- ⚠️ 响应数据中设备预约和实验代操作订单的 `date` 字段获取逻辑变更
- ⚠️ 原来从 `reservation_date` 获取，现在从 `time_slots` 数组中提取第一个日期

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "type": "equipment",
        "type_name": "设备预约",
        "title": "高倍显微镜",
        "date": "2026-01-10",              // 从 time_slots 中提取
        "status": 0,
        "status_text": "待审核",
        "created_at": "2026-01-07 10:00:00"
      },
      {
        "id": 3,
        "type": "experiment",
        "type_name": "实验代操作",
        "title": "灌胃-小鼠-20只",
        "date": "2026-01-10",              // 从 time_slots 中提取
        "status": 0,
        "status_text": "待审核",
        "created_at": "2026-01-07 10:30:00"
      }
    ],
    "total": 10,
    "page": 1,
    "page_size": 10
  }
}
```

**说明**: 
- 如果订单包含多个日期，列表中显示第一个日期
- 详情页面会显示完整的 time_slots 数组

---

### 4. 订单详情接口
**接口地址**: `GET /api/h5/my-orders/:type/:id`

**变更点**:
- ⚠️ 设备预约和实验代操作订单详情中 `reservation_date` 字段已删除
- ⚠️ `time_slots` 格式变更

**设备预约订单详情**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "type": "equipment",
    "type_name": "设备预约",
    "id": 1,
    "equipment": {
      "id": 1,
      "name": "高倍显微镜",
      "details": {...}
    },
    "time_slots": [                          // 新格式
      "2026-01-10 09:00-10:00",
      "2026-01-10 10:00-11:00",
      "2026-01-11 09:00-10:00"
    ],
    "status": 1,
    "status_text": "进行中",
    "handler": {...},
    "created_at": "2026-01-07 10:00:00"
  }
}
```

**实验代操作订单详情**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "type": "experiment",
    "type_name": "实验代操作",
    "id": 1,
    "operation_content": {...},
    "animal_type": {...},
    "quantity": 20,
    "time_slots": [                          // 新格式
      "2026-01-10 09:00-12:00",
      "2026-01-10 13:00-18:00",
      "2026-01-11 09:00-12:00"
    ],
    "status": 1,
    "status_text": "进行中",
    "handler": {...},
    "created_at": "2026-01-07 10:00:00"
  }
}
```

---

### 5. 查询设备可用时间段接口
**接口地址**: `GET /api/h5/equipment/:id/available-slots?date=2026-01-10`

**变更点**:
- ✅ 接口保持不变
- ✅ 请求参数保持不变
- ✅ 响应格式保持不变

**说明**: 该接口仍然按单日查询，但后端会从新格式的 time_slots 中提取指定日期的时间段进行计算。

---

## 💻 前端需要调整的地方

### 1. 时间段格式处理

#### 原有代码示例（需要修改）
```javascript
// ❌ 旧格式
const formData = {
  equipment_id: 1,
  user_id: 10,
  reservation_date: "2026-01-10",
  time_slots: ["09:00-10:00", "10:00-11:00"]
};
```

#### 调整后代码示例
```javascript
// ✅ 新格式
const formData = {
  equipment_id: 1,
  user_id: 10,
  time_slots: [
    "2026-01-10 09:00-10:00",
    "2026-01-10 10:00-11:00"
  ]
};
```

### 2. 跨天预约支持

#### 场景：用户选择多个日期的时间段

```javascript
// ✅ 支持跨天预约
const formData = {
  equipment_id: 1,
  user_id: 10,
  time_slots: [
    "2026-01-10 09:00-10:00",
    "2026-01-10 10:00-11:00",
    "2026-01-11 09:00-10:00",    // 第二天
    "2026-01-12 14:00-15:00"     // 第三天
  ]
};
```

### 3. 订单详情展示

#### 调整建议

**旧方式**: 展示单个日期 + 时间段列表
```
预约日期: 2026-01-10
预约时间: 09:00-10:00, 10:00-11:00
```

**新方式**: 按日期分组展示
```javascript
// 建议：从 time_slots 中提取并按日期分组
const groupByDate = (timeSlots) => {
  const grouped = {};
  timeSlots.forEach(slot => {
    const [date, time] = slot.split(' ');
    if (!grouped[date]) {
      grouped[date] = [];
    }
    grouped[date].push(time);
  });
  return grouped;
};

// 结果示例
{
  "2026-01-10": ["09:00-10:00", "10:00-11:00"],
  "2026-01-11": ["09:00-10:00", "14:00-15:00"]
}

// 展示为
预约时间:
  2026-01-10: 09:00-10:00, 10:00-11:00
  2026-01-11: 09:00-10:00, 14:00-15:00
```

### 4. 表单组件调整

#### 原有表单逻辑（需要调整）
```javascript
// ❌ 旧逻辑：日期和时间段分开选择
<DatePicker v-model="form.reservation_date" />
<TimeSlotSelect v-model="form.time_slots" :date="form.reservation_date" />
```

#### 调整后表单逻辑
```javascript
// ✅ 新逻辑：支持多日期选择
<div v-for="(dateSlots, index) in selectedDateSlots" :key="index">
  <DatePicker v-model="dateSlots.date" />
  <TimeSlotSelect 
    v-model="dateSlots.slots" 
    :date="dateSlots.date" 
    :equipment-id="form.equipment_id"
  />
  <Button @click="addDate">+ 添加更多日期</Button>
</div>

// 提交前处理
const formatTimeSlots = () => {
  const timeSlots = [];
  selectedDateSlots.forEach(item => {
    item.slots.forEach(slot => {
      timeSlots.push(`${item.date} ${slot}`);
    });
  });
  return timeSlots;
};

form.time_slots = formatTimeSlots();
```

### 5. 筛选条件保持不变

```javascript
// ✅ 筛选条件不需要修改，仍然可以使用
const params = {
  page: 1,
  page_size: 10,
  reservation_date: "2026-01-10",  // 仍然可用，查询包含该日期的订单
  // 或
  start_date: "2026-01-01",
  end_date: "2026-01-31"
};
```

---

## 🛠️ 工具函数建议

### 1. 时间段格式化函数

```javascript
/**
 * 将时间段数组按日期分组
 * @param {Array<string>} timeSlots - 格式：["2026-01-10 09:00-10:00", ...]
 * @returns {Object} - 格式：{ "2026-01-10": ["09:00-10:00", ...], ... }
 */
export const groupTimeSlotsByDate = (timeSlots) => {
  const grouped = {};
  timeSlots.forEach(slot => {
    const [date, time] = slot.split(' ');
    if (!grouped[date]) {
      grouped[date] = [];
    }
    grouped[date].push(time);
  });
  return grouped;
};

/**
 * 将日期分组的时间段转换为数组格式
 * @param {Object} groupedSlots - 格式：{ "2026-01-10": ["09:00-10:00", ...], ... }
 * @returns {Array<string>} - 格式：["2026-01-10 09:00-10:00", ...]
 */
export const flattenTimeSlots = (groupedSlots) => {
  const flattened = [];
  Object.keys(groupedSlots).forEach(date => {
    groupedSlots[date].forEach(time => {
      flattened.push(`${date} ${time}`);
    });
  });
  return flattened;
};

/**
 * 从时间段数组中提取所有日期
 * @param {Array<string>} timeSlots - 格式：["2026-01-10 09:00-10:00", ...]
 * @returns {Array<string>} - 格式：["2026-01-10", "2026-01-11", ...]
 */
export const extractDatesFromSlots = (timeSlots) => {
  const dates = new Set();
  timeSlots.forEach(slot => {
    const [date] = slot.split(' ');
    dates.add(date);
  });
  return Array.from(dates).sort();
};

/**
 * 格式化时间段显示
 * @param {Array<string>} timeSlots - 格式：["2026-01-10 09:00-10:00", ...]
 * @returns {string} - 格式：2026-01-10: 09:00-10:00, 10:00-11:00 | 2026-01-11: 09:00-10:00
 */
export const formatTimeSlotsDisplay = (timeSlots) => {
  const grouped = groupTimeSlotsByDate(timeSlots);
  return Object.keys(grouped)
    .sort()
    .map(date => `${date}: ${grouped[date].join(', ')}`)
    .join(' | ');
};
```

### 2. 使用示例

```javascript
// 订单详情展示
import { formatTimeSlotsDisplay } from '@/utils/timeSlot';

const order = {
  id: 1,
  time_slots: [
    "2026-01-10 09:00-10:00",
    "2026-01-10 10:00-11:00",
    "2026-01-11 09:00-10:00"
  ]
};

const displayText = formatTimeSlotsDisplay(order.time_slots);
// 结果: "2026-01-10: 09:00-10:00, 10:00-11:00 | 2026-01-11: 09:00-10:00"
```

---

## ✅ 验证清单

在完成前端调整后，请确认以下功能正常：

### 管理端 - 设备预约
- [ ] 新增订单：能够选择单日或多日时间段
- [ ] 编辑订单：能够正确回显和修改时间段
- [ ] 订单列表：正确展示时间段信息
- [ ] 订单详情：正确展示完整的预约信息
- [ ] 按日期筛选：能够查询到包含指定日期的订单
- [ ] 查询可用时间段：能够正确显示某日的可用时间段

### 管理端 - 实验代操作
- [ ] 新增订单：能够选择单日或多日时间段
- [ ] 编辑订单：能够正确回显和修改时间段
- [ ] 订单列表：正确展示时间段信息
- [ ] 订单详情：正确展示完整的预约信息
- [ ] 按日期筛选：能够查询到包含指定日期的订单

### H5 端 - 设备预约
- [ ] 提交订单：能够选择单日或多日时间段
- [ ] 我的订单列表：正确展示订单信息（日期从 time_slots 提取）
- [ ] 订单详情：正确展示完整的预约信息
- [ ] 查询可用时间段：能够正确显示某日的可用时间段

### H5 端 - 实验代操作
- [ ] 提交订单：能够选择单日或多日时间段
- [ ] 我的订单列表：正确展示订单信息（日期从 time_slots 提取）
- [ ] 订单详情：正确展示完整的预约信息

---

## ❓ 常见问题

### Q1: 旧数据如何处理？
**A**: 项目尚未正式发布，后端已删除并重建数据库，不存在旧数据兼容问题。

### Q2: 是否必须支持跨天预约？
**A**: 是的，这是本次调整的核心功能。前端表单应该允许用户选择多个日期的时间段。

### Q3: 单日预约和多日预约的区别？
**A**: 从接口层面没有区别，time_slots 数组中可以包含一个或多个日期的时间段。

### Q4: 日期筛选接口变化了吗？
**A**: 筛选参数没有变化，但筛选逻辑变了。原来是精确匹配 reservation_date，现在是查询 time_slots 中包含指定日期的订单。

### Q5: 时间段格式验证？
**A**: 前端提交时，time_slots 数组中的每个元素必须符合 `YYYY-MM-DD HH:MM-HH:MM` 格式。

---

## 📞 技术支持

如有疑问，请联系后端开发团队。

**文档版本**: v1.0  
**最后更新**: 2026-01-21
